<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المشتريات والمرتجعات</title>
    
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        :root {
            /* base palette */
            --primary: #0b84ff;
            --primary-600: #0a6be0;
            --primary-700: #0a58c8;
            --flash-gradient: linear-gradient(
                90deg, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 0.6) 50%, rgba(255, 255, 255, 0) 100%);
            --accent: #7c3aed;       /* purple */
            --accent-600: #6d28d9;
            --teal: #10b981;
            --amber: #f59e0b;
            --rose: #ef4444;
            --const:white;
            --bg: #f6f8fc;
            --surface: #ffffff;
            --surface-2: #f9fbff;
            --text: #0f172a;
            --text-soft: #334155;
            --muted: #64748b;
            --border: rgba(2,6,23,0.08);

            --radius: 14px;
            --radius-sm: 10px;
            --radius-lg: 20px;

            --shadow-1: 0 10px 24px rgba(15,23,42,0.06);
            --shadow-2: 0 12px 28px rgba(11,132,255,0.14);
            --ring: 0 0 0 4px rgba(11,132,255,0.18);

            --header-h: 64px;
            --sidebar-w: 264px;
            --sidebar-w-mini: 84px;

            --fast: .15s ease;
            --normal: .25s cubic-bezier(.2,.8,.2,1);

            /* gradients */
            --grad-1: linear-gradient(135deg, #0b84ff, #7c3aed);
            --grad-2: linear-gradient(135deg, #10b981, #0ea5e9);
            --grad-3: linear-gradient(135deg, #f59e0b, #ef4444);
            --grad-4: linear-gradient(135deg, #ef4444, #b91c1c);
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --flashy: linear-gradient(90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.06) 28%,
                rgba(255, 255, 255, 0.22) 50%,
                rgba(255, 255, 255, 0.06) 72%,
                rgba(255, 255, 255, 0) 100%);
            --bg: #0c1222;
            --surface: #0f162d;
            --surface-2: #0a1122;
            --text: #e5e7eb;
            --text-soft: #cbd5e1;
            --muted: #94a3b8;
            --border: rgba(148,163,184,0.15);
            --shadow-1: 0 12px 30px rgba(0,0,0,0.45);
            --shadow-2: 0 18px 40px rgba(11,132,255,0.22);
            --ring: 0 0 0 4px rgba(11,132,255,0.24);
            --accent-left: #7c3aed;
            --accent-left-weak: rgba(124,58,237,0.06);
            --accent-right: #b9770e;
            --accent-right-weak: rgba(185,119,14,0.06);
            --row-bg-odd-1: #0f1724;
            --row-bg-odd-2: #0b1220;
            --row-bg-even-1: #0b1220;
            --row-bg-even-2: #05070d;
            --row-border-strong: rgba(148,163,184,0.08);
            --row-border-soft: rgba(148,163,184,0.04);
            --row-shadow: 0 8px 26px rgba(2,6,23,0.55);
            --row-hover-tint: rgba(124,58,237,0.06);
            --row-radius: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            transition: background-color var(--normal);
        }

        /* App Container */
        .app-container {
            max-width: 1800px;
            margin: 0 auto;
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-1);
            overflow: hidden;
            transition: all var(--normal);
        }

        /* Header */
        .app-header {
            background: var(--grad-1);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background: var(--flash-gradient);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { right: -100%; }
            100% { right: 100%; }
        }

        .app-header h1 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        /* Global Search */
        .global-search {
            flex: 1;
            max-width: 400px;
            position: relative;
            z-index: 1;
        }

        .global-search input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 15px;
            transition: all var(--normal);
        }

        .global-search input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .global-search input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: var(--radius);
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--normal);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -100%;
            width: 100%;
            height: 100%;
            background: var(--flash-gradient);
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity var(--normal);
        }

        .btn:hover::after {
            opacity: 1;
            right: 100%;
            transition: right 0.7s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-600);
            transform: translateY(-2px);
            box-shadow: var(--shadow-2);
        }

        .btn-success {
            background: var(--teal);
            color: white;
        }

        .btn-danger {
            background: var(--rose);
            color: white;
        }

        .btn-warning {
            background: var(--amber);
            color: white;
        }

        .btn-info {
            background: var(--accent);
            color: white;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            gap: 5px;
        }

        .badge-pending { background: var(--amber); color: white; }
        .badge-received { background: var(--teal); color: white; }
        .badge-cancelled { background: var(--rose); color: white; }
        .badge-partial { background: var(--accent); color: white; }
        .badge-returned { background: var(--primary); color: white; }

        /* Status Badges for Batches */
        .badge-active { background: var(--teal); color: white; }
        .badge-consumed { background: var(--muted); color: white; }
        .badge-cancelled { background: var(--rose); color: white; }
        .badge-reverted { background: var(--amber); color: white; }

        /* Main Content */
        .main-content {
            padding: 30px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: var(--muted);
            cursor: pointer;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            transition: all var(--normal);
            position: relative;
        }

        .tab:hover {
            color: var(--primary);
            background: rgba(11, 132, 255, 0.05);
        }

        .tab.active {
            color: var(--primary);
            background: rgba(11, 132, 255, 0.1);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* Table Container */
        .table-container {
            background: var(--surface-2);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-1);
            border: 1px solid var(--border);
            margin-top: 20px;
        }

        .table-header {
            background: var(--surface);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        /* Enhanced Table Styles */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table thead {
            background: var(--surface);
        }

        .data-table th {
            padding: 16px;
            text-align: right;
            font-weight: 700;
            color: var(--text);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
            font-size: 14px;
            background: var(--surface);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            font-size: 14px;
            transition: background-color var(--fast);
        }

        .data-table tbody tr {
            background: var(--surface);
        }

        .data-table tbody tr:nth-child(even) {
            background: var(--surface-2);
        }

        .data-table tbody tr:hover {
            background: rgba(11, 132, 255, 0.05);
        }

        /* Search within sections */
        .section-search {
            margin-bottom: 20px;
        }

        .search-box {
            position: relative;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            color: var(--text);
            font-size: 14px;
            transition: all var(--normal);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--ring);
        }

        .search-box svg {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
        }

        /* Modal Improvements */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-2);
            animation: slideUp 0.3s ease;
        }

        /* Invoice Items in Modal */
        .invoice-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .invoice-item-row.header {
            font-weight: 700;
            background: var(--surface-2);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* Return Link in Invoice Details */
        .return-link {
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: color var(--fast);
        }

        .return-link:hover {
            color: var(--primary-600);
            text-decoration: underline;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--border);
            transition: all var(--normal);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: var(--grad-1);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-2);
        }

        /* Loader */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .app-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .global-search {
                max-width: 100%;
            }
            
            .invoice-item-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .data-table {
                font-size: 13px;
            }
            
            .data-table th,
            .data-table td {
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- سأواصل مع الهيكل الرئيسي -->
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1>
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 17H15M9 13H15M9 9H11M19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V19C21 20.1046 20.1046 21 19 21Z" 
                          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                نظام إدارة المشتريات والمرتجعات
            </h1>
            
            <!-- Global Search -->
            <div class="global-search">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" 
                          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <input type="text" id="globalSearch" placeholder="ابحث في الموردين، الفواتير، المرتجعات...">
            </div>
            
            <div class="header-actions">
                <button class="btn btn-primary" onclick="PurchaseManager.openNewInvoiceModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    فاتورة شراء جديدة
                </button>
                <button class="btn btn-info" onclick="UIManager.switchTab('analytics')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M10.325 4.317C11.489 1.811 13.512 1.811 14.675 4.317C15.29 5.642 16.746 6.468 18.151 6.218C20.884 5.746 22.254 8.246 20.27 10.121C19.17 11.169 18.744 12.729 19.357 14.029C20.551 16.52 18.26 18.773 16.067 17.444C14.802 16.652 13.197 16.652 11.932 17.444C9.739 18.773 7.448 16.52 8.643 14.029C9.255 12.729 8.829 11.169 7.73 10.121C5.746 8.246 7.116 5.746 9.849 6.218C11.254 6.468 12.709 5.642 13.325 4.317" 
                              stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    لوحة التحليلات
                </button>
                <button class="btn btn-warning" onclick="UIManager.switchTab('returns')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M9 17L4 12M4 12L9 7M4 12H20M13 12C13 15.3137 15.6863 18 19 18C20.6569 18 22 16.6569 22 15C22 13.3431 20.6569 12 19 12C17.3431 12 16 10.6569 16 9C16 7.34315 17.3431 6 19 6C20.6569 6 22 4.65685 22 3" 
                              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    إدارة المرتجعات
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>إجمالي المشتريات</h3>
                    <div class="stat-value" id="totalPurchases">125,450 ج.م</div>
                    <div class="stat-change positive">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                            <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        12% عن الشهر الماضي
                    </div>
                </div>
                <div class="stat-card">
                    <h3>قيمة المرتجعات</h3>
                    <div class="stat-value" id="totalReturns">8,750 ج.م</div>
                    <div class="stat-change negative">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                            <path d="M12 5V19M5 12L12 19L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        5% عن الشهر الماضي
                    </div>
                </div>
                <div class="stat-card">
                    <h3>فواتير قيد المعالجة</h3>
                    <div class="stat-value" id="pendingInvoices">7 فواتير</div>
                    <div class="stat-change positive">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                            <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        3 جديدة
                    </div>
                </div>
                <div class="stat-card">
                    <h3>معدل المرتجعات</h3>
                    <div class="stat-value" id="returnRate">3.2%</div>
                    <div class="stat-change positive">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                            <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        0.5% تحسن
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="UIManager.switchTab('invoices')">فواتير المشتريات</button>
                <button class="tab" onclick="UIManager.switchTab('returns')">المرتجعات</button>
                <button class="tab" onclick="UIManager.switchTab('analytics')">التحليلات</button>
            </div>

            <!-- Invoices Tab -->
            <div id="invoicesTab" class="tab-content">
                <div class="section-search">
                    <div class="search-box">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                            <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" 
                                  stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <input type="text" id="supplierSearch" placeholder="ابحث باسم المورد أو رقم الفاتورة..." 
                               onkeyup="SearchManager.searchSuppliers(this.value)">
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>فواتير المشتريات</h3>
                        <div class="table-actions">
                            <button class="btn btn-light btn-sm" onclick="ExportManager.exportInvoices()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <path d="M4 16L8.58579 11.4142C9.36684 10.6332 10.6332 10.6332 11.4142 11.4142L16 16M14 14L15.5858 12.4142C16.3668 11.6332 17.6332 11.6332 18.4142 12.4142L22 16M2 18H22" 
                                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                تصدير البيانات
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>المورد</th>
                                    <th>تاريخ الشراء</th>
                                    <th>رقم فاتورة المورد</th>
                                    <th>الحالة</th>
                                    <th>الكميات</th>
                                    <th>الإجمالي</th>
                                    <th>المرتجعات</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTable">
                                <!-- سيتم تعبئته بواسطة JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Returns Tab -->
            <div id="returnsTab" class="tab-content hidden">
                <div class="section-search">
                    <div class="search-box">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                            <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" 
                                  stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <input type="text" id="returnsSearch" placeholder="ابحث في المرتجعات..." 
                               onkeyup="SearchManager.searchReturns(this.value)">
                    </div>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3>المرتجعات</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="ReturnManager.openNewReturnModal()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                إضافة مرتجع
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>رقم المرتجع</th>
                                    <th>الفاتورة الأصلية</th>
                                    <th>المورد</th>
                                    <th>نوع المرتجع</th>
                                    <th>تاريخ المرتجع</th>
                                    <th>الكمية</th>
                                    <th>القيمة</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="returnsTable">
                                <!-- سيتم تعبئته بواسطة JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsTab" class="tab-content hidden">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>معدل الرضا عن المشتريات</h3>
                        <div class="stat-value">94.2%</div>
                        <div class="stat-change positive">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            +2.1% هذا الشهر
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>متوسط وقت معالجة المرتجع</h3>
                        <div class="stat-value">3.2 أيام</div>
                        <div class="stat-change positive">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            -0.8 أيام
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>التوفير من المرتجعات</h3>
                        <div class="stat-value">2,150 ج.م</div>
                        <div class="stat-change positive">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            +15% عن الشهر الماضي
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>أكثر المنتجات مرتجعات</h3>
                        <div class="stat-value">شاشات 24 بوصة</div>
                        <div class="stat-change negative">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M12 5V19M5 12L12 19L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            12 مرتجع هذا الشهر
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- View Invoice Modal -->
    <div class="modal" id="viewInvoiceModal">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--grad-1);">
                <h2>تفاصيل الفاتورة</h2>
                <button class="modal-close" onclick="UIManager.closeModal('viewInvoiceModal')">×</button>
            </div>
            <div class="modal-body" id="invoiceDetails">
                <!-- سيتم تعبئته بواسطة JavaScript -->
            </div>
        </div>
    </div>

    <!-- View Return Details Modal -->
    <div class="modal" id="viewReturnModal">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--grad-4);">
                <h2>تفاصيل المرتجع</h2>
                <button class="modal-close" onclick="UIManager.closeModal('viewReturnModal')">×</button>
            </div>
            <div class="modal-body" id="returnDetails">
                <!-- سيتم تعبئته بواسطة JavaScript -->
            </div>
        </div>
    </div>

    <!-- New Return Modal -->
    <div class="modal" id="returnModal">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--grad-3);">
                <h2>إنشاء مرتجع للمشتريات</h2>
                <button class="modal-close" onclick="ReturnManager.closeReturnModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- محتوى مودال المرتجع -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Modules will be loaded here -->
    <script>
        // ==============================
// Module 1: API Service
// ==============================
const ApiService = (() => {
    const BASE_URL = 'api'; // سيتم تعيينه لاحقاً
    
    const handleResponse = async (response) => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    };

    const handleError = (error) => {
        console.error('API Error:', error);
        UIManager.showError('حدث خطأ في الاتصال بالخادم');
        throw error;
    };

    return {
        // Purchase Invoices
        async getInvoices(filters = {}) {
            try {
                const query = new URLSearchParams(filters).toString();
                const response = await fetch(`${BASE_URL}/purchase_invoices?${query}`);
                return await handleResponse(response);
            } catch (error) {
                handleError(error);
            }
        },

        async getInvoiceDetails(invoiceId) {
            try {
                const response = await fetch(`${BASE_URL}/purchase_invoices/${invoiceId}`);
                return await handleResponse(response);
            } catch (error) {
                handleError(error);
            }
        },

        async updateInvoiceStatus(invoiceId, status, reason = '') {
            try {
                const response = await fetch(`${BASE_URL}/purchase_invoices/${invoiceId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, reason })
                });
                return await handleResponse(response);
            } catch (error) {
                handleError(error);
            }
        },

        // Returns
        async getReturns(filters = {}) {
            try {
                const query = new URLSearchParams(filters).toString();
                const response = await fetch(`${BASE_URL}/returns?${query}`);
                return await handleResponse(response);
            } catch (error) {
                handleError(error);
            }
        },

        async createReturn(returnData) {
            try {
                const response = await fetch(`${BASE_URL}/returns`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(returnData)
                });
                return await handleResponse(response);
            } catch (error) {
                handleError(error);
            }
        },

        async updateReturnStatus(returnId, status) {
            try {
                const response = await fetch(`${BASE_URL}/returns/${returnId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                return await handleResponse(response);
            } catch (error) {
                handleError(error);
            }
        },

        // Batches
        async getBatchesForInvoice(invoiceId) {
            try {
                const response = await fetch(`${BASE_URL}/purchase_invoices/${invoiceId}/batches`);
                return await handleResponse(response);
            } catch (error) {
                handleError(error);
            }
        },

        // Suppliers
        async getSuppliers(search = '') {
            try {
                const response = await fetch(`${BASE_URL}/suppliers?search=${encodeURIComponent(search)}`);
                return await handleResponse(response);
            } catch (error) {
                handleError(error);
            }
        },

        // Statistics
        async getStatistics() {
            try {
                const response = await fetch(`${BASE_URL}/statistics`);
                return await handleResponse(response);
            } catch (error) {
                handleError(error);
            }
        }
    };
})();

// ==============================
// Module 2: UI Manager
// ==============================
const UIManager = (() => {
    let currentLoader = null;

    return {
        // Tab Switching
        switchTab(tabName) {
            // إخفاء كل المحتويات
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // إزالة النشاط من كل التبويبات
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إظهار المحتوى المطلوب
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.classList.remove('hidden');
            }
            
            // تفعيل التبويب المطلوب
            const tabButton = document.querySelector(`.tab[onclick*="${tabName}"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            
            // إذا كانت تبويب التحليلات، تحديث المخططات
            if (tabName === 'analytics') {
                this.updateCharts();
            }
        },

        // Modal Management
        openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        },

        closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        },

        // Loaders
        showLoader(text = 'جاري التحميل...') {
            this.hideLoader(); // تأكد من عدم وجود لودر مسبق
            
            currentLoader = Swal.fire({
                title: text,
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });
        },

        hideLoader() {
            if (currentLoader) {
                currentLoader.close();
                currentLoader = null;
            }
        },

        // Notifications (SweetAlert2)
        showSuccess(message, title = 'نجاح') {
            return Swal.fire({
                title: title,
                text: message,
                icon: 'success',
                confirmButtonText: 'موافق',
                confirmButtonColor: '#10b981'
            });
        },

        showError(message, title = 'خطأ') {
            return Swal.fire({
                title: title,
                text: message,
                icon: 'error',
                confirmButtonText: 'موافق',
                confirmButtonColor: '#ef4444'
            });
        },

        showConfirm(message, title = 'تأكيد') {
            return Swal.fire({
                title: title,
                text: message,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم',
                cancelButtonText: 'لا',
                confirmButtonColor: '#0b84ff',
                cancelButtonColor: '#6b7280'
            });
        },

        // Formatting Helpers
        formatCurrency(amount) {
            return new Intl.NumberFormat('ar-EG', {
                style: 'currency',
                currency: 'EGP',
                minimumFractionDigits: 0
            }).format(amount);
        },

        formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG');
        },

        // Charts
        updateCharts() {
            // سيتم تطوير هذا الجزء لاحقاً
            console.log('Updating charts...');
        }
    };
})();

// ==============================
// Module 3: Purchase Manager
// ==============================
const PurchaseManager = (() => {
    let currentInvoices = [];

    return {
        // Initialize
        async init() {
            try {
                UIManager.showLoader('جاري تحميل الفواتير...');
                const invoices = await ApiService.getInvoices();
                currentInvoices = invoices;
                this.renderInvoices(invoices);
                this.updateStats(invoices);
                UIManager.hideLoader();
            } catch (error) {
                UIManager.hideLoader();
                UIManager.showError('فشل تحميل الفواتير');
            }
        },

        // Render Invoices Table
        renderInvoices(invoices) {
            const tbody = document.getElementById('invoicesTable');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (invoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center" style="padding: 40px;">
                            <div style="color: var(--muted); font-size: 16px;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="margin-bottom: 10px;">
                                    <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" 
                                          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <div>لا توجد فواتير</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            invoices.forEach(invoice => {
                const row = this.createInvoiceRow(invoice);
                tbody.appendChild(row);
            });
        },

        // Create Invoice Row
        createInvoiceRow(invoice) {
            const row = document.createElement('tr');
            
            const statusBadge = this.getStatusBadge(invoice.status);
            const returnCount = invoice.returns?.length || 0;
            const totalReturns = invoice.returns?.reduce((sum, ret) => sum + ret.total_amount, 0) || 0;
            
            row.innerHTML = `
                <td><strong>${invoice.id}</strong></td>
                <td><strong>${invoice.supplier?.name || 'غير معروف'}</strong></td>
                <td>${UIManager.formatDate(invoice.purchase_date)}</td>
                <td>${invoice.supplier_invoice_number || '-'}</td>
                <td>${statusBadge}</td>
                <td>
                    <div style="font-size: 12px;">
                        <div>${invoice.items_count || 0} منتج</div>
                        <div style="color: var(--muted);">${returnCount} مرتجع</div>
                    </div>
                </td>
                <td><strong>${UIManager.formatCurrency(invoice.total_amount)}</strong></td>
                <td>
                    ${returnCount > 0 ? 
                        `<span class="badge badge-returned">${returnCount} مرتجع</span>
                         <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">
                            ${UIManager.formatCurrency(totalReturns)}
                         </div>` : 
                        '<span style="color: var(--muted);">لا يوجد</span>'
                    }
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-info btn-sm" onclick="PurchaseManager.viewInvoice(${invoice.id})">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            عرض
                        </button>
                        ${invoice.status === 'fully_received' ? `
                            <button class="btn btn-danger btn-sm" onclick="ReturnManager.openNewReturnModal(${invoice.id})">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 17L4 12M4 12L9 7M4 12H20M13 12C13 15.3137 15.6863 18 19 18C20.6569 18 22 16.6569 22 15C22 13.3431 20.6569 12 19 12C17.3431 12 16 10.6569 16 9C16 7.34315 17.3431 6 19 6C20.6569 6 22 4.65685 22 3" 
                                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                مرتجع
                            </button>
                        ` : ''}
                        ${invoice.status === 'pending' ? `
                            <button class="btn btn-success btn-sm" onclick="PurchaseManager.receiveInvoice(${invoice.id})">
                                استلام
                            </button>
                        ` : ''}
                    </div>
                </td>
            `;
            
            return row;
        },

        // View Invoice Details
        async viewInvoice(invoiceId) {
            try {
                UIManager.showLoader('جاري تحميل تفاصيل الفاتورة...');
                const invoice = await ApiService.getInvoiceDetails(invoiceId);
                const batches = await ApiService.getBatchesForInvoice(invoiceId);
                
                this.renderInvoiceDetails(invoice, batches);
                UIManager.openModal('viewInvoiceModal');
                UIManager.hideLoader();
            } catch (error) {
                UIManager.hideLoader();
                UIManager.showError('فشل تحميل تفاصيل الفاتورة');
            }
        },

        // Render Invoice Details Modal
        renderInvoiceDetails(invoice, batches) {
            const modalBody = document.getElementById('invoiceDetails');
            if (!modalBody) return;

            const returns = invoice.returns || [];
            
            modalBody.innerHTML = `
                <div style="background: var(--surface-2); padding: 20px; border-radius: var(--radius); margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">رقم الفاتورة</label>
                            <div style="font-weight: 600; font-size: 18px;">${invoice.id}</div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">المورد</label>
                            <div style="font-weight: 600;">${invoice.supplier?.name || 'غير معروف'}</div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">تاريخ الشراء</label>
                            <div style="font-weight: 600;">${UIManager.formatDate(invoice.purchase_date)}</div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px;">الحالة</label>
                            <div>${this.getStatusBadge(invoice.status)}</div>
                        </div>
                    </div>
                </div>

                ${returns.length > 0 ? `
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: var(--radius); border-right: 4px solid var(--rose); margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; color: var(--rose);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align: middle; margin-left: 5px;">
                                <path d="M9 17L4 12M4 12L9 7M4 12H20M13 12C13 15.3137 15.6863 18 19 18C20.6569 18 22 16.6569 22 15C22 13.3431 20.6569 12 19 12C17.3431 12 16 10.6569 16 9C16 7.34315 17.3431 6 19 6C20.6569 6 22 4.65685 22 3" 
                                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            المرتجعات المرتبطة (${returns.length})
                        </h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${returns.map(ret => `
                                <a class="return-link" onclick="ReturnManager.viewReturnDetails('${ret.id}')">
                                    ${ret.id} - ${UIManager.formatCurrency(ret.total_amount)}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <h3 style="margin-bottom: 15px;">بنود الفاتورة والدفعات</h3>
                <div style="overflow-x: auto;">
                    <div class="invoice-item-row header">
                        <div>المنتج</div>
                        <div>رقم الدفعة</div>
                        <div>الكمية</div>
                        <div>المتاح</div>
                        <div>سعر التكلفة</div>
                        <div>حالة الدفعة</div>
                        <div>المرتجعات</div>
                    </div>
                    ${batches.map(batch => {
                        const batchReturns = returns.filter(ret => 
                            ret.items?.some(item => item.batch_id === batch.id)
                        );
                        const returnedQty = batchReturns.reduce((sum, ret) => 
                            sum + ret.items?.reduce((itemSum, item) => 
                                item.batch_id === batch.id ? itemSum + item.quantity : itemSum, 0
                            ), 0
                        );
                        
                        return `
                            <div class="invoice-item-row">
                                <div>${batch.product?.name || batch.product_id}</div>
                                <div>${batch.id}</div>
                                <div>${batch.original_qty}</div>
                                <div>
                                    <div>${batch.remaining}</div>
                                    ${returnedQty > 0 ? `
                                        <div style="font-size: 11px; color: var(--rose);">
                                            مرتجع: ${returnedQty}
                                        </div>
                                    ` : ''}
                                </div>
                                <div>${UIManager.formatCurrency(batch.unit_cost)}</div>
                                <div>${this.getBatchStatusBadge(batch.status)}</div>
                                <div>
                                    ${batchReturns.length > 0 ? `
                                        <div style="display: flex; flex-direction: column; gap: 2px;">
                                            ${batchReturns.map(ret => `
                                                <a class="return-link" onclick="ReturnManager.viewReturnDetails('${ret.id}')" 
                                                   style="font-size: 11px;">
                                                    ${ret.id}
                                                </a>
                                            `).join('')}
                                        </div>
                                    ` : '-'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div style="text-align: left; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="UIManager.closeModal('viewInvoiceModal')">إغلاق</button>
                    ${invoice.status === 'fully_received' ? `
                        <button class="btn btn-danger" onclick="ReturnManager.openNewReturnModal(${invoice.id}); UIManager.closeModal('viewInvoiceModal')">
                            إنشاء مرتجع جديد
                        </button>
                    ` : ''}
                </div>
            `;
        },

        // Receive Invoice
        async receiveInvoice(invoiceId) {
            const result = await UIManager.showConfirm('هل تريد تأكيد استلام هذه الفاتورة بالكامل؟', 'تأكيد الاستلام');
            
            if (result.isConfirmed) {
                try {
                    UIManager.showLoader('جاري تأكيد الاستلام...');
                    await ApiService.updateInvoiceStatus(invoiceId, 'fully_received');
                    
                    await UIManager.showSuccess('تم استلام الفاتورة بنجاح');
                    await this.init(); // إعادة تحميل الفواتير
                    UIManager.hideLoader();
                } catch (error) {
                    UIManager.hideLoader();
                    UIManager.showError('فشل تأكيد استلام الفاتورة');
                }
            }
        },

        // Helper Functions
        getStatusBadge(status) {
            const badges = {
                pending: '<span class="badge badge-pending">قيد الانتظار</span>',
                partial_received: '<span class="badge badge-partial">مستلمة جزئياً</span>',
                fully_received: '<span class="badge badge-received">مستلمة</span>',
                cancelled: '<span class="badge badge-cancelled">ملغاة</span>'
            };
            return badges[status] || '<span class="badge badge-secondary">غير معروف</span>';
        },

        getBatchStatusBadge(status) {
            const badges = {
                active: '<span class="badge badge-active">نشط</span>',
                consumed: '<span class="badge badge-consumed">مستهلك</span>',
                cancelled: '<span class="badge badge-cancelled">ملغي</span>',
                reverted: '<span class="badge badge-reverted">معاد</span>'
            };
            return badges[status] || '<span class="badge badge-secondary">غير معروف</span>';
        },

        updateStats(invoices) {
            const totalPurchases = invoices.reduce((sum, invoice) => sum + invoice.total_amount, 0);
            const totalReturns = invoices.reduce((sum, invoice) => 
                sum + (invoice.returns?.reduce((retSum, ret) => retSum + ret.total_amount, 0) || 0), 0);
            const pendingInvoices = invoices.filter(invoice => invoice.status === 'pending').length;
            const returnRate = totalPurchases > 0 ? ((totalReturns / totalPurchases) * 100).toFixed(1) : 0;
            
            document.getElementById('totalPurchases').textContent = UIManager.formatCurrency(totalPurchases);
            document.getElementById('totalReturns').textContent = UIManager.formatCurrency(totalReturns);
            document.getElementById('pendingInvoices').textContent = pendingInvoices + ' فواتير';
            document.getElementById('returnRate').textContent = returnRate + '%';
        },

        // New Invoice Modal
        openNewInvoiceModal() {
            UIManager.showSuccess('هذه الميزة قيد التطوير', 'قريباً');
            // سيتم تنفيذها لاحقاً
        }
    };
})();

// ==============================
// Module 4: Return Manager
// ==============================
const ReturnManager = (() => {
    let currentReturns = [];
    let selectedInvoice = null;
    let selectedBatches = [];

    return {
        // Initialize
        async init() {
            try {
                UIManager.showLoader('جاري تحميل المرتجعات...');
                const returns = await ApiService.getReturns();
                currentReturns = returns;
                this.renderReturns(returns);
                this.updateReturnsStats(returns);
                UIManager.hideLoader();
            } catch (error) {
                UIManager.hideLoader();
                UIManager.showError('فشل تحميل المرتجعات');
            }
        },

        // Render Returns Table
        renderReturns(returns) {
            const tbody = document.getElementById('returnsTable');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (returns.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center" style="padding: 40px;">
                            <div style="color: var(--muted); font-size: 16px;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="margin-bottom: 10px;">
                                    <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" 
                                          stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <div>لا توجد مرتجعات</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            returns.forEach(ret => {
                const row = this.createReturnRow(ret);
                tbody.appendChild(row);
            });
        },

        // Create Return Row
        createReturnRow(ret) {
            const row = document.createElement('tr');
            
            const typeText = this.getReturnTypeText(ret.return_type);
            const statusBadge = this.getReturnStatusBadge(ret.status);
            const totalItems = ret.items?.reduce((sum, item) => sum + item.quantity, 0) || 0;
            
            row.innerHTML = `
                <td><strong>${ret.id}</strong></td>
                <td>${ret.purchase_invoice_id}</td>
                <td>${ret.supplier?.name || 'غير معروف'}</td>
                <td><span class="badge" style="background: ${this.getReturnTypeColor(ret.return_type)}">${typeText}</span></td>
                <td>${UIManager.formatDate(ret.return_date)}</td>
                <td>${totalItems} منتج</td>
                <td><strong>${UIManager.formatCurrency(ret.total_amount)}</strong></td>
                <td>${statusBadge}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-info btn-sm" onclick="ReturnManager.viewReturnDetails('${ret.id}')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            تفاصيل
                        </button>
                        ${ret.status === 'pending' ? `
                            <button class="btn btn-success btn-sm" onclick="ReturnManager.completeReturn('${ret.id}')">
                                إكمال
                            </button>
                        ` : ''}
                    </div>
                </td>
            `;
            
            return row;
        },

        // View Return Details
        async viewReturnDetails(returnId) {
            try {
                UIManager.showLoader('جاري تحميل تفاصيل المرتجع...');
                // في التطبيق الحقيقي، سيكون هناك API للحصول على تفاصيل المرتجع
                const returnData = currentReturns.find(r => r.id === returnId);
                if (returnData) {
                    this.renderReturnDetails(returnData);
                    UIManager.openModal('viewReturnModal');
                }
                UIManager.hideLoader();
            } catch (error) {
                UIManager.hideLoader();
                UIManager.showError('فشل تحميل تفاصيل المرتجع');
            }
        },

        // Render Return Details Modal
        renderReturnDetails(returnData) {
            const modalBody = document.getElementById('returnDetails');
            if (!modalBody) return;

            const typeText = this.getReturnTypeText(returnData.return_type);
            const statusText = returnData.status === 'completed' ? 'مكتمل' : 
                             returnData.status === 'pending' ? 'قيد المعالجة' : 'ملغي';
            
            modalBody.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: var(--surface-2); padding: 15px; border-radius: var(--radius-sm); border-right: 4px solid var(--primary);">
                        <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">رقم المرتجع</div>
                        <div style="font-weight: 600; font-size: 16px;">${returnData.id}</div>
                    </div>
                    <div style="background: var(--surface-2); padding: 15px; border-radius: var(--radius-sm); border-right: 4px solid var(--accent);">
                        <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">الفاتورة الأصلية</div>
                        <div style="font-weight: 600; font-size: 16px;">${returnData.purchase_invoice_id}</div>
                    </div>
                    <div style="background: var(--surface-2); padding: 15px; border-radius: var(--radius-sm); border-right: 4px solid var(--teal);">
                        <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">المورد</div>
                        <div style="font-weight: 600; font-size: 16px;">${returnData.supplier?.name || 'غير معروف'}</div>
                    </div>
                    <div style="background: var(--surface-2); padding: 15px; border-radius: var(--radius-sm); border-right: 4px solid var(--amber);">
                        <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">الحالة</div>
                        <div style="font-weight: 600; font-size: 16px;">${statusText}</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h4 style="margin-bottom: 10px;">سبب المرتجع</h4>
                    <div style="background: var(--surface-2); padding: 15px; border-radius: var(--radius-sm); border-right: 4px solid var(--info);">
                        ${returnData.reason}
                    </div>
                </div>
                
                <div>
                    <h4 style="margin-bottom: 15px;">المنتجات المرتجعة</h4>
                    <div style="overflow-x: auto;">
                        <div class="invoice-item-row header">
                            <div>المنتج</div>
                            <div>رقم الدفعة</div>
                            <div>الكمية</div>
                            <div>سعر التكلفة</div>
                            <div>الإجمالي</div>
                        </div>
                        ${returnData.items?.map(item => `
                            <div class="invoice-item-row">
                                <div>${item.product?.name || item.product_id}</div>
                                <div>${item.batch_id}</div>
                                <div>${item.quantity}</div>
                                <div>${UIManager.formatCurrency(item.unit_cost)}</div>
                                <div><strong>${UIManager.formatCurrency(item.total_cost)}</strong></div>
                            </div>
                        `).join('') || '<div class="invoice-item-row">لا توجد منتجات</div>'}
                    </div>
                </div>
                
                <div style="text-align: left; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="UIManager.closeModal('viewReturnModal')">إغلاق</button>
                    ${returnData.status === 'pending' ? `
                        <button class="btn btn-success" onclick="ReturnManager.completeReturn('${returnData.id}')">
                            إكمال المعالجة
                        </button>
                    ` : ''}
                </div>
            `;
        },

        // Complete Return Processing
        async completeReturn(returnId) {
            const result = await UIManager.showConfirm('هل تريد تأكيد إكمال معالجة هذا المرتجع؟', 'تأكيد الإكمال');
            
            if (result.isConfirmed) {
                try {
                    UIManager.showLoader('جاري إكمال المعالجة...');
                    await ApiService.updateReturnStatus(returnId, 'completed');
                    
                    await UIManager.showSuccess('تم إكمال معالجة المرتجع بنجاح');
                    await this.init(); // إعادة تحميل المرتجعات
                    UIManager.closeModal('viewReturnModal');
                    UIManager.hideLoader();
                } catch (error) {
                    UIManager.hideLoader();
                    UIManager.showError('فشل إكمال معالجة المرتجع');
                }
            }
        },

        // Open New Return Modal
        async openNewReturnModal(invoiceId = null) {
            if (invoiceId) {
                // إذا تم توفير invoiceId، قم بتحميل الفاتورة المحددة
                try {
                    UIManager.showLoader('جاري تحميل بيانات الفاتورة...');
                    const invoice = await ApiService.getInvoiceDetails(invoiceId);
                    const batches = await ApiService.getBatchesForInvoice(invoiceId);
                    
                    selectedInvoice = invoice;
                    this.renderNewReturnModal(invoice, batches);
                    UIManager.openModal('returnModal');
                    UIManager.hideLoader();
                } catch (error) {
                    UIManager.hideLoader();
                    UIManager.showError('فشل تحميل بيانات الفاتورة');
                }
            } else {
                // مودال فارغ لإنشاء مرتجع جديد
                this.renderNewReturnModal();
                UIManager.openModal('returnModal');
            }
        },

        // Render New Return Modal
        renderNewReturnModal(invoice = null, batches = []) {
            const modalBody = document.querySelector('#returnModal .modal-body');
            if (!modalBody) return;

            if (invoice) {
                modalBody.innerHTML = `
                    <h3 style="margin-bottom: 20px;">إنشاء مرتجع للفاتورة #${invoice.id}</h3>
                    <div style="background: var(--surface-2); padding: 20px; border-radius: var(--radius); margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <div style="font-size: 12px; color: var(--muted);">المورد</div>
                                <div style="font-weight: 600;">${invoice.supplier?.name}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--muted);">تاريخ الفاتورة</div>
                                <div style="font-weight: 600;">${UIManager.formatDate(invoice.purchase_date)}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--muted);">القيمة الإجمالية</div>
                                <div style="font-weight: 600;">${UIManager.formatCurrency(invoice.total_amount)}</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">نوع المرتجع</label>
                        <select class="form-control" id="returnType" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-sm);">
                            <option value="">اختر نوع المرتجع</option>
                            <option value="supplier_return">إرجاع للمورد</option>
                            <option value="damaged">تلف في المخزن</option>
                            <option value="expired">منتهي الصلاحية</option>
                            <option value="wrong_item">منتج خاطئ</option>
                            <option value="excess">كمية زائدة</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">سبب المرتجع</label>
                        <textarea class="form-control" id="returnReason" rows="3" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-sm);" 
                                  placeholder="اكتب سبب الإرجاع..."></textarea>
                    </div>

                    <h4 style="margin-bottom: 15px;">اختر المنتجات المرتجعة</h4>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); padding: 15px;">
                        ${batches.map(batch => `
                            <div style="background: var(--surface); padding: 15px; border-radius: var(--radius-sm); margin-bottom: 10px; border: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <strong>${batch.product?.name || batch.product_id}</strong>
                                        <div style="font-size: 12px; color: var(--muted); margin-top: 2px;">
                                            دفعة: ${batch.id} | متاح: ${batch.remaining}
                                        </div>
                                    </div>
                                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                        <input type="checkbox" class="batch-checkbox" value="${batch.id}" 
                                               onchange="ReturnManager.toggleBatchSelection(${batch.id})">
                                        اختر للإرجاع
                                    </label>
                                </div>
                                
                                <div id="batchDetails-${batch.id}" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div>
                                            <label style="font-size: 12px; color: var(--muted);">الكمية المتاحة</label>
                                            <div style="font-weight: 600;">${batch.remaining}</div>
                                        </div>
                                        <div>
                                            <label style="font-size: 12px; color: var(--muted);">الكمية المرتجعة</label>
                                            <input type="number" class="qty-input" min="0" max="${batch.remaining}" 
                                                   style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: var(--radius-sm);"
                                                   onchange="ReturnManager.updateReturnQty(${batch.id}, this.value)">
                                        </div>
                                        <div style="grid-column: span 2;">
                                            <label style="font-size: 12px; color: var(--muted);">سبب إرجاع هذا المنتج</label>
                                            <input type="text" class="reason-input" 
                                                   style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: var(--radius-sm);"
                                                   onchange="ReturnManager.updateItemReason(${batch.id}, this.value)"
                                                   placeholder="سبب محدد لهذا المنتج...">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div style="text-align: left; margin-top: 30px;">
                        <button class="btn btn-light" onclick="ReturnManager.closeReturnModal()">إلغاء</button>
                        <button class="btn btn-success" onclick="ReturnManager.submitReturn()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M5 13L9 17L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            تأكيد إنشاء المرتجع
                        </button>
                    </div>
                `;
            } else {
                // سيتم تنفيذ واجهة اختيار الفاتورة أولاً
                modalBody.innerHTML = `
                    <h3 style="margin-bottom: 20px;">إنشاء مرتجع جديد</h3>
                    <p style="margin-bottom: 20px; color: var(--muted);">يرجى اختيار فاتورة المشتريات أولاً</p>
                    <div style="text-align: left;">
                        <button class="btn btn-light" onclick="ReturnManager.closeReturnModal()">إلغاء</button>
                    </div>
                `;
            }
        },

        // Batch Selection Management
        toggleBatchSelection(batchId) {
            const checkbox = document.querySelector(`.batch-checkbox[value="${batchId}"]`);
            const detailsDiv = document.getElementById(`batchDetails-${batchId}`);
            
            if (checkbox.checked) {
                detailsDiv.style.display = 'block';
                // إضافة إلى المحددات
                const batch = selectedInvoice.batches?.find(b => b.id === batchId);
                if (batch) {
                    selectedBatches.push({
                        id: batch.id,
                        product_id: batch.product_id,
                        batch_id: batch.id,
                        quantity: 0,
                        unit_cost: batch.unit_cost,
                        reason: ''
                    });
                }
            } else {
                detailsDiv.style.display = 'none';
                // إزالة من المحددات
                selectedBatches = selectedBatches.filter(b => b.id !== batchId);
            }
        },

        updateReturnQty(batchId, qty) {
            const batch = selectedBatches.find(b => b.id === batchId);
            if (batch) {
                const maxQty = selectedInvoice.batches?.find(b => b.id === batchId)?.remaining || 0;
                batch.quantity = Math.min(Math.max(0, parseInt(qty) || 0), maxQty);
            }
        },

        updateItemReason(batchId, reason) {
            const batch = selectedBatches.find(b => b.id === batchId);
            if (batch) {
                batch.reason = reason;
            }
        },

        // Submit Return
        async submitReturn() {
            if (selectedBatches.length === 0) {
                UIManager.showError('يرجى اختيار منتجات للإرجاع');
                return;
            }

            const returnType = document.getElementById('returnType').value;
            const returnReason = document.getElementById('returnReason').value;

            if (!returnType) {
                UIManager.showError('يرجى اختيار نوع المرتجع');
                return;
            }

            if (!returnReason.trim()) {
                UIManager.showError('يرجى كتابة سبب المرتجع');
                return;
            }

            const result = await UIManager.showConfirm('هل تريد تأكيد إنشاء المرتجع؟', 'تأكيد الإنشاء');
            
            if (result.isConfirmed) {
                try {
                    UIManager.showLoader('جاري إنشاء المرتجع...');
                    
                    const returnData = {
                        purchase_invoice_id: selectedInvoice.id,
                        return_type: returnType,
                        reason: returnReason,
                        return_date: new Date().toISOString().split('T')[0],
                        items: selectedBatches.map(batch => ({
                            batch_id: batch.batch_id,
                            product_id: batch.product_id,
                            quantity: batch.quantity,
                            unit_cost: batch.unit_cost,
                            item_reason: batch.reason
                        }))
                    };

                    await ApiService.createReturn(returnData);
                    
                    await UIManager.showSuccess('تم إنشاء المرتجع بنجاح');
                    this.closeReturnModal();
                    await PurchaseManager.init(); // تحديث الفواتير
                    await this.init(); // تحديث المرتجعات
                    UIManager.hideLoader();
                } catch (error) {
                    UIManager.hideLoader();
                    UIManager.showError('فشل إنشاء المرتجع');
                }
            }
        },

        closeReturnModal() {
            selectedInvoice = null;
            selectedBatches = [];
            UIManager.closeModal('returnModal');
        },

        // Helper Functions
        getReturnTypeText(type) {
            const types = {
                supplier_return: 'إرجاع للمورد',
                damaged: 'تلف في المخزن',
                expired: 'منتهي الصلاحية',
                wrong_item: 'منتج خاطئ',
                excess: 'كمية زائدة'
            };
            return types[type] || 'غير محدد';
        },

        getReturnTypeColor(type) {
            const colors = {
                supplier_return: 'var(--rose)',
                damaged: 'var(--amber)',
                expired: 'var(--muted)',
                wrong_item: 'var(--accent)',
                excess: 'var(--primary)'
            };
            return colors[type] || 'var(--muted)';
        },

        getReturnStatusBadge(status) {
            const badges = {
                pending: '<span class="badge badge-pending">قيد المعالجة</span>',
                completed: '<span class="badge badge-received">مكتمل</span>',
                cancelled: '<span class="badge badge-cancelled">ملغي</span>'
            };
            return badges[status] || '<span class="badge badge-secondary">غير معروف</span>';
        },

        updateReturnsStats(returns) {
            const totalValue = returns.reduce((sum, ret) => sum + ret.total_amount, 0);
            const averageValue = returns.length > 0 ? (totalValue / returns.length).toFixed(0) : 0;
            const pendingReturns = returns.filter(ret => ret.status === 'pending').length;
            
            // تحديث الإحصائيات إذا كانت العناصر موجودة
            const returnsTotalValue = document.getElementById('returnsTotalValue');
            const averageReturnValue = document.getElementById('averageReturnValue');
            const pendingReturnsEl = document.getElementById('pendingReturns');
            
            if (returnsTotalValue) returnsTotalValue.textContent = UIManager.formatCurrency(totalValue);
            if (averageReturnValue) averageReturnValue.textContent = UIManager.formatCurrency(averageValue);
            if (pendingReturnsEl) pendingReturnsEl.textContent = pendingReturns + ' مرتجعات';
        }
    };
})();

// ==============================
// Module 5: Search Manager
// ==============================
const SearchManager = (() => {
    let searchTimeout = null;

    return {
        // Global Search
        searchGlobal(query) {
            clearTimeout(searchTimeout);
            
            searchTimeout = setTimeout(() => {
                // البحث في جميع الأقسام
                this.searchSuppliers(query);
                this.searchReturns(query);
                
                // يمكن إضافة بحث في الفواتير أيضاً
                const currentTab = document.querySelector('.tab.active');
                if (currentTab) {
                    const tabText = currentTab.textContent;
                    if (tabText.includes('الفواتير')) {
                        this.searchInInvoices(query);
                    }
                }
            }, 300);
        },

        // Search in Suppliers
        async searchSuppliers(query) {
            try {
                if (query.trim().length < 2) {
                    PurchaseManager.init(); // إعادة تحميل الكل
                    return;
                }

                const suppliers = await ApiService.getSuppliers(query);
                // هنا يمكن تصفية الفواتير حسب الموردين
                console.log('Search results for suppliers:', suppliers);
                // في التطبيق الحقيقي، سيتم تصفية الفواتير حسب الموردين
            } catch (error) {
                console.error('Search error:', error);
            }
        },

        // Search in Returns
        async searchReturns(query) {
            try {
                if (query.trim().length < 2) {
                    ReturnManager.init(); // إعادة تحميل الكل
                    return;
                }

                const returns = await ApiService.getReturns({ search: query });
                ReturnManager.renderReturns(returns);
            } catch (error) {
                console.error('Search error:', error);
            }
        },

        // Search in Invoices
        async searchInInvoices(query) {
            try {
                const invoices = await ApiService.getInvoices({ search: query });
                PurchaseManager.renderInvoices(invoices);
            } catch (error) {
                console.error('Search error:', error);
            }
        }
    };
})();

// ==============================
// Module 6: Export Manager
// ==============================
const ExportManager = (() => {
    return {
        exportInvoices() {
            UIManager.showSuccess('جاري تجهيز ملف التصدير...', 'قريباً');
            // سيتم تنفيذ التصدير لاحقاً
        },

        exportReturns() {
            UIManager.showSuccess('جاري تجهيز ملف التصدير...', 'قريباً');
            // سيتم تنفيذ التصدير لاحقاً
        }
    };
})();

// ==============================
// Initialization
// ==============================
document.addEventListener('DOMContentLoaded', function() {
    // تهيئة المودالز
    PurchaseManager.init();
    ReturnManager.init();
    
    // إضافة مستمع للبحث العام
    document.getElementById('globalSearch').addEventListener('input', function(e) {
        SearchManager.searchGlobal(e.target.value);
    });
    
    // إضافة مستمع للبحث في قسم الموردين
    document.getElementById('supplierSearch')?.addEventListener('input', function(e) {
        SearchManager.searchSuppliers(e.target.value);
    });
    
    // إضافة مستمع للبحث في قسم المرتجعات
    document.getElementById('returnsSearch')?.addEventListener('input', function(e) {
        SearchManager.searchReturns(e.target.value);
    });
    
    // إضافة دالة لتغيير الثيم
    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
    }
    
    // يمكن إضافة زر لتغيير الثيم لاحقاً
});



    </script>
</body>
</html>