<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المشتريات والمرتجعات</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
            --secondary: #6b7280;
            --light: #f9fafb;
            --dark: #111827;
            --bg: #ffffff;
            --border: #e5e7eb;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --radius-lg: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


          .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        .app-container {
            max-width: 1800px;
            margin: 0 auto;
            background: var(--bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .app-header h1 {
            font-size: 26px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-header h1 svg {
            flex-shrink: 0;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Global Search */
        .global-search {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .global-search input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .global-search input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .global-search input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        .global-search svg {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: var(--radius);
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), #1e40af);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #0284c7);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #4b5563);
            color: white;
        }

        .btn-light {
            background: white;
            color: var(--dark);
            border: 1px solid var(--border);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            gap: 5px;
        }

        .badge-pending { background: linear-gradient(135deg, var(--warning), #d97706); color: white; }
        .badge-received { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .badge-cancelled { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
        .badge-partial { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .badge-returned { background: linear-gradient(135deg, var(--info), #0284c7); color: white; }

        /* Main Content */
        .main-content {
            padding: 30px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--info));
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--secondary);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* Filters */
        .filters-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 11px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-top: 25px;
        }

        .table-header {
            background: var(--light);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h3 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 700;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1000px;
        }

        .data-table thead {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .data-table th {
            padding: 16px;
            text-align: right;
            font-weight: 700;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
            font-size: 14px;
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            font-size: 14px;
        }

        .data-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .data-table tbody tr:hover {
            background-color: #f8fafc;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 22px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 30px;
            max-height: calc(90vh - 150px);
            overflow-y: auto;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .chart-card h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Return Details Modal */
        .return-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .detail-item {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .detail-item label {
            display: block;
            font-size: 12px;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .detail-item .value {
            font-weight: 700;
            font-size: 16px;
            color: var(--dark);
        }

        /* Return Items List */
        .return-items-list {
            margin-top: 20px;
        }

        .return-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .return-item-row.header {
            font-weight: 700;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: var(--secondary);
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 992px) {
            .main-content {
                padding: 20px;
            }
            
            .app-header {
                padding: 20px;
                flex-direction: column;
                align-items: stretch;
            }
            
            .global-search {
                max-width: 100%;
            }
            
            .header-actions {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-card {
                padding: 15px;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .p-20 { padding: 20px; }
        .d-flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-10 { gap: 10px; }
        .gap-15 { gap: 15px; }
        .gap-20 { gap: 20px; }
        .w-100 { width: 100%; }
        .hidden { display: none; }
    </style>

        <style>
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
            --secondary: #6b7280;
            --light: #f9fafb;
            --dark: #111827;
            --bg: #ffffff;
            --border: #e5e7eb;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* Header Styles */
        .app-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            gap: 5px;
        }

        .badge-pending { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .badge-received { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .badge-cancelled { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .badge-partial { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .badge-returned { background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; }

        /* Main Content */
        .main-content {
            padding: 25px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-change {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* Filters Section */
        .filters-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-select, .form-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .table-header {
            background: var(--light);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .table-header h3 {
            color: var(--dark);
            font-size: 18px;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table thead {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .data-table th {
            padding: 15px;
            text-align: right;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .data-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .data-table tbody tr:hover {
            background-color: #f8fafc;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #2563eb);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #0284c7);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #4b5563);
            color: white;
        }

        .btn-light {
            background: white;
            color: var(--dark);
            border: 1px solid var(--border);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 30px;
            max-height: calc(90vh - 150px);
            overflow-y: auto;
        }

        /* Return Modal Specific */
        .return-steps {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: var(--light);
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 600;
            color: var(--secondary);
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .step.completed .step-number {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .step-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--secondary);
        }

        .step.active .step-title {
            color: var(--primary);
        }

        .step.completed .step-title {
            color: var(--success);
        }

        .return-form-section {
            display: none;
        }

        .return-form-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .return-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .return-item-card {
            background: var(--light);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .return-item-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .item-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .info-item label {
            font-size: 12px;
            color: var(--secondary);
            margin-bottom: 4px;
            display: block;
        }

        .info-item .value {
            font-weight: 600;
            color: var(--dark);
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .qty-input {
            width: 100px;
            text-align: center;
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .qty-available {
            font-size: 12px;
            color: var(--secondary);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }

            .app-header {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
            }

            .header-actions {
                width: 100%;
                flex-wrap: wrap;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .action-buttons {
                flex-wrap: wrap;
            }

            .modal-body {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1>
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 17H15M9 13H15M9 9H11M19 21H5C3.89543 21 3 20.1046 3 19V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V19C21 20.1046 20.1046 21 19 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                نظام إدارة المشتريات والمرتجعات
            </h1>
            
            <!-- Global Search -->
            <div class="global-search">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <input type="text" id="globalSearch" placeholder="ابحث في الموردين، الفواتير، المرتجعات...">
            </div>
            
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openNewInvoiceModal()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    فاتورة شراء جديدة
                </button>
                <button class="btn btn-info" onclick="openAnalyticsPage()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10.325 4.317C11.489 1.811 13.512 1.811 14.675 4.317C15.29 5.642 16.746 6.468 18.151 6.218C20.884 5.746 22.254 8.246 20.27 10.121C19.17 11.169 18.744 12.729 19.357 14.029C20.551 16.52 18.26 18.773 16.067 17.444C14.802 16.652 13.197 16.652 11.932 17.444C9.739 18.773 7.448 16.52 8.643 14.029C9.255 12.729 8.829 11.169 7.73 10.121C5.746 8.246 7.116 5.746 9.849 6.218C11.254 6.468 12.709 5.642 13.325 4.317" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    لوحة التحليلات
                </button>
                <button class="btn btn-warning" onclick="openReturnsPage()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 17L4 12M4 12L9 7M4 12H20M13 12C13 15.3137 15.6863 18 19 18C20.6569 18 22 16.6569 22 15C22 13.3431 20.6569 12 19 12C17.3431 12 16 10.6569 16 9C16 7.34315 17.3431 6 19 6C20.6569 6 22 4.65685 22 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    إدارة المرتجعات
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>إجمالي المشتريات</h3>
                    <div class="stat-value" id="totalPurchases">125,450 ج.م</div>
                    <div class="stat-change positive">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                            <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        12% عن الشهر الماضي
                    </div>
                </div>
                <div class="stat-card">
                    <h3>قيمة المرتجعات</h3>
                    <div class="stat-value" id="totalReturns">8,750 ج.م</div>
                    <div class="stat-change negative">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                            <path d="M12 5V19M5 12L12 19L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        5% عن الشهر الماضي
                    </div>
                </div>
                <div class="stat-card">
                    <h3>فواتير قيد المعالجة</h3>
                    <div class="stat-value" id="pendingInvoices">7 فواتير</div>
                    <div class="stat-change positive">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                            <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        3 جديدة
                    </div>
                </div>
                <div class="stat-card">
                    <h3>معدل المرتجعات</h3>
                    <div class="stat-value" id="returnRate">3.2%</div>
                    <div class="stat-change positive">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                            <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        0.5% تحسن
                    </div>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="filters-card">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>المورد</label>
                        <select class="form-select" id="supplierFilter">
                            <option value="">كل الموردين</option>
                            <option value="1">مورد التقنية المتطورة</option>
                            <option value="2">شركة الأجهزة الحديثة</option>
                            <option value="3">مستلزمات المكتبة</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>حالة الفاتورة</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">كل الحالات</option>
                            <option value="pending">قيد الانتظار</option>
                            <option value="fully_received">مستلمة بالكامل</option>
                            <option value="partially_received">مستلمة جزئياً</option>
                            <option value="cancelled">ملغاة</option>
                            <option value="has_returns">لديها مرتجعات</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>من تاريخ</label>
                        <input type="date" class="form-input" id="dateFrom">
                    </div>
                    <div class="filter-group">
                        <label>إلى تاريخ</label>
                        <input type="date" class="form-input" id="dateTo">
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            بحث
                        </button>
                        <button class="btn btn-light" onclick="resetFilters()">تصفير</button>
                        <button class="btn btn-secondary" onclick="exportData()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                <path d="M4 16L8.58579 11.4142C9.36684 10.6332 10.6332 10.6332 11.4142 11.4142L16 16M14 14L15.5858 12.4142C16.3668 11.6332 17.6332 11.6332 18.4142 12.4142L22 16M2 18H22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            تصدير
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs for Different Views -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('invoices')">فواتير المشتريات</button>
                <button class="tab" onclick="switchTab('returns')">المرتجعات</button>
                <button class="tab" onclick="switchTab('analytics')">التحليلات</button>
            </div>

            <!-- Invoices Table -->
            <div id="invoicesTab" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>فواتير المشتريات</h3>
                        <div class="table-actions">
                            <button class="btn btn-light btn-sm" onclick="exportInvoices()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <path d="M4 16L8.58579 11.4142C9.36684 10.6332 10.6332 10.6332 11.4142 11.4142L16 16M14 14L15.5858 12.4142C16.3668 11.6332 17.6332 11.6332 18.4142 12.4142L22 16M2 18H22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                تصدير البيانات
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>المورد</th>
                                    <th>تاريخ الشراء</th>
                                    <th>رقم فاتورة المورد</th>
                                    <th>الحالة</th>
                                    <th>الكميات</th>
                                    <th>الإجمالي</th>
                                    <th>المرتجعات</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTable">
                                <!-- سيتم تعبئته بواسطة JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Summary -->
                <div class="d-flex justify-between mt-20">
                    <div id="filterSummary" class="p-20" style="background: white; border-radius: 12px; box-shadow: var(--shadow); max-width: 600px;">
                        <h4>ملخص نتائج البحث</h4>
                        <div class="d-flex justify-between mt-10">
                            <div>
                                <div><strong>عدد الفواتير:</strong> <span id="filteredCount">0</span></div>
                                <div><strong>إجمالي القيمة:</strong> <span id="filteredTotal">0 ج.م</span></div>
                            </div>
                            <div>
                                <div><strong>متوسط القيمة:</strong> <span id="filteredAverage">0 ج.م</span></div>
                                <div><strong>معدل المرتجعات:</strong> <span id="filteredReturnRate">0%</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); width: 400px;">
                        <div class="mb-20">
                            <strong>إجمالي الفواتير المعروضة:</strong>
                            <span style="float: left; background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px;" id="displayedTotal">125,450 ج.م</span>
                        </div>
                        <div>
                            <strong>صافي المشتريات:</strong>
                            <span style="float: left; background: var(--success); color: white; padding: 4px 12px; border-radius: 20px;" id="netPurchases">116,700 ج.م</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Returns Tab -->
            <div id="returnsTab" class="tab-content hidden">
                <div class="filters-card">
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label>نوع المرتجع</label>
                            <select class="form-select" id="returnTypeFilter">
                                <option value="">كل الأنواع</option>
                                <option value="supplier_return">إرجاع للمورد</option>
                                <option value="damaged">تلف في المخزن</option>
                                <option value="expired">منتهي الصلاحية</option>
                                <option value="wrong_item">منتج خاطئ</option>
                                <option value="excess">كمية زائدة</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>حالة المرتجع</label>
                            <select class="form-select" id="returnStatusFilter">
                                <option value="">كل الحالات</option>
                                <option value="pending">قيد المعالجة</option>
                                <option value="completed">مكتمل</option>
                                <option value="cancelled">ملغي</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>من تاريخ</label>
                            <input type="date" class="form-input" id="returnDateFrom">
                        </div>
                        <div class="filter-group">
                            <label>إلى تاريخ</label>
                            <input type="date" class="form-input" id="returnDateTo">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="filterReturns()">بحث</button>
                            <button class="btn btn-light" onclick="resetReturnFilters()">تصفير</button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h3>المرتجعات</h3>
                        <div class="table-actions">
                            <button class="btn btn-primary btn-sm" onclick="openNewReturnModal()">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                إضافة مرتجع
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>رقم المرتجع</th>
                                    <th>الفاتورة الأصلية</th>
                                    <th>المورد</th>
                                    <th>نوع المرتجع</th>
                                    <th>تاريخ المرتجع</th>
                                    <th>الكمية</th>
                                    <th>القيمة</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="returnsTable">
                                <!-- سيتم تعبئته بواسطة JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Returns Summary -->
                <div class="stats-grid mt-20">
                    <div class="stat-card">
                        <h3>إجمالي المرتجعات</h3>
                        <div class="stat-value" id="returnsTotalValue">8,750 ج.م</div>
                        <div class="stat-change negative">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M12 5V19M5 12L12 19L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            +3% عن الشهر الماضي
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>متوسط قيمة المرتجع</h3>
                        <div class="stat-value" id="averageReturnValue">437 ج.م</div>
                        <div class="stat-change positive">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            -5% عن الشهر الماضي
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>أعلى مورد مرتجعات</h3>
                        <div class="stat-value" id="topReturnSupplier">شركة الأجهزة الحديثة</div>
                        <div class="stat-change">
                            1,250 ج.م هذا الشهر
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>المرتجعات قيد المعالجة</h3>
                        <div class="stat-value" id="pendingReturns">3 مرتجعات</div>
                        <div class="stat-change positive">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            -1 عن الأسبوع الماضي
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsTab" class="tab-content hidden">
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 3V21H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 16L9.5 10.5L12 14L16 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            اتجاه المرتجعات الشهري
                        </h3>
                        <div class="chart-container">
                            <canvas id="monthlyTrendsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 2C14.5013 4.73835 15.9228 8.29203 16 12C15.9228 15.708 14.5013 19.2616 12 22" stroke="currentColor" stroke-width="2"/>
                                <path d="M2 12H22" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            توزيع أنواع المرتجعات
                        </h3>
                        <div class="chart-container">
                            <canvas id="returnsByTypeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M3 9H21" stroke="currentColor" stroke-width="2"/>
                                <path d="M9 21V9" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            المرتجعات حسب المورد
                        </h3>
                        <div class="chart-container">
                            <canvas id="returnsBySupplierChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h3>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18 20V10M12 20V4M6 20V14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            مؤشرات الأداء الرئيسية
                        </h3>
                        <div class="chart-container">
                            <canvas id="kpiChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>معدل الرضا عن المشتريات</h3>
                        <div class="stat-value">94.2%</div>
                        <div class="stat-change positive">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            +2.1% هذا الشهر
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>متوسط وقت معالجة المرتجع</h3>
                        <div class="stat-value">3.2 أيام</div>
                        <div class="stat-change positive">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            -0.8 أيام
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>التوفير من المرتجعات</h3>
                        <div class="stat-value">2,150 ج.م</div>
                        <div class="stat-change positive">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M12 19V5M5 12L12 5L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            +15% عن الشهر الماضي
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>أكثر المنتجات مرتجعات</h3>
                        <div class="stat-value">شاشات 24 بوصة</div>
                        <div class="stat-change negative">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M12 5V19M5 12L12 19L19 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            12 مرتجع هذا الشهر
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals
    <div class="modal" id="returnModal">
     Return Modal Content (from original code) 
    </div> -->



    <div class="modal" id="viewReturnModal">
        <!-- View Return Modal -->
    </div>


       <div class="modal" id="viewInvoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تفاصيل الفاتورة</h2>
                <button class="modal-close" onclick="closeViewModal()">×</button>
            </div>
            <div class="modal-body" id="invoiceDetails">
                <!-- سيتم تعبئته بواسطة JavaScript -->
            </div>
        </div>
    </div>
<!-- Return Modal -->
    <div class="modal" id="returnModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إنشاء مرتجع للمشتريات</h2>
                <button class="modal-close" onclick="closeReturnModal()">×</button>
            </div>
            <div class="modal-body">
                <!-- Steps Navigation -->
                <div class="return-steps">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-title">اختيار المنتجات</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-title">تحديد الكميات</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-title">تأكيد المرتجع</div>
                    </div>
                </div>

                <!-- Step 1: Select Products -->
                <div class="return-form-section active" id="step1Content">
                    <div class="form-group">
                        <label>نوع المرتجع</label>
                        <select class="form-control" id="returnType">
                            <option value="">اختر نوع المرتجع</option>
                            <option value="supplier_return">إرجاع للمورد</option>
                            <option value="damaged">تلف في المخزن</option>
                            <option value="expired">منتهي الصلاحية</option>
                            <option value="wrong_item">منتج خاطئ</option>
                            <option value="excess">كمية زائدة</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>سبب المرتجع</label>
                        <textarea class="form-control" id="returnReason" rows="3" placeholder="اكتب سبب الإرجاع..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>دفعات الفاتورة المتاحة للإرجاع</label>
                        <div class="return-items-grid" id="batchesList">
                            <!-- سيتم تعبئته بواسطة JavaScript -->
                        </div>
                    </div>

                    <div style="text-align: left; margin-top: 30px;">
                        <button class="btn btn-primary" onclick="nextStep(2)">
                            التالي
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M9 5L16 12L9 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Quantities -->
                <div class="return-form-section" id="step2Content">
                    <h3 style="margin-bottom: 20px;">تحديد الكميات المرتجعة</h3>
                    <div id="quantitiesList">
                        <!-- سيتم تعبئته بواسطة JavaScript -->
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button class="btn btn-light" onclick="prevStep(1)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M15 19L8 12L15 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            السابق
                        </button>
                        <button class="btn btn-primary" onclick="nextStep(3)">
                            التالي
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M9 5L16 12L9 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Confirmation -->
                <div class="return-form-section" id="step3Content">
                    <h3 style="margin-bottom: 20px;">تأكيد بيانات المرتجع</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>رقم المرتجع</label>
                            <input type="text" class="form-control" value="PR-2024-001" readonly>
                        </div>
                        <div class="form-group">
                            <label>تاريخ المرتجع</label>
                            <input type="date" class="form-control" id="returnDate">
                        </div>
                        <div class="form-group">
                            <label>المخزن المستلم</label>
                            <input type="text" class="form-control" placeholder="المخزن الرئيسي" readonly>
                        </div>
                        <div class="form-group">
                            <label>المسؤول عن الاستلام</label>
                            <input type="text" class="form-control" placeholder="اسم المستخدم" readonly>
                        </div>
                    </div>

                    <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-top: 20px;">
                        <h4 style="margin-bottom: 15px;">ملخص المرتجع</h4>
                        <div id="returnSummary">
                            <!-- سيتم تعبئته بواسطة JavaScript -->
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button class="btn btn-light" onclick="prevStep(2)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M15 19L8 12L15 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            السابق
                        </button>
                        <button class="btn btn-success" onclick="submitReturn()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M5 13L9 17L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            تأكيد إنشاء المرتجع
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // البيانات الرئيسية
        const invoices = [
            {
                id: 1001,
                supplier: "مورد التقنية المتطورة",
                purchaseDate: "2024-01-15",
                supplierInvoice: "INV-2024-001",
                status: "fully_received",
                total: 25000,
                items: 5,
                returned: 2,
                returnValue: 1200,
                batches: [
                    { id: 1, product: "لابتوب ديل", batch: "B001", qty: 10, remaining: 10, cost: 1500, expiry: "2025-12-31" },
                    { id: 2, product: "ماوس لاسلكي", batch: "B002", qty: 50, remaining: 48, cost: 100, expiry: "2026-06-30" },
                    { id: 3, product: "كيبورد ميكانيكي", batch: "B003", qty: 20, remaining: 20, cost: 300, expiry: "2027-01-31" }
                ]
            },
            {
                id: 1002,
                supplier: "شركة الأجهزة الحديثة",
                purchaseDate: "2024-01-10",
                supplierInvoice: "INV-2024-002",
                status: "pending",
                total: 18000,
                items: 3,
                returned: 0,
                returnValue: 0,
                batches: [
                    { id: 4, product: "شاشة 24 بوصة", batch: "B004", qty: 15, remaining: 15, cost: 1200, expiry: null },
                    { id: 5, product: "سماعات رأس", batch: "B005", qty: 30, remaining: 30, cost: 200, expiry: null }
                ]
            },
            {
                id: 1003,
                supplier: "مستلزمات المكتبة",
                purchaseDate: "2024-01-05",
                supplierInvoice: "INV-2024-003",
                status: "fully_received",
                total: 32000,
                items: 8,
                returned: 1,
                returnValue: 750,
                batches: [
                    { id: 6, product: "طابعة ليزر", batch: "B006", qty: 5, remaining: 4, cost: 2500, expiry: null },
                    { id: 7, product: "حبر طابعة", batch: "B007", qty: 50, remaining: 49, cost: 150, expiry: "2024-12-31" }
                ]
            }
        ];

        const returns = [
            {
                id: "RET-2024-001",
                invoiceId: 1001,
                supplier: "مورد التقنية المتطورة",
                type: "wrong_item",
                date: "2024-01-20",
                status: "completed",
                items: [
                    { product: "ماوس لاسلكي", batch: "B002", quantity: 2, price: 100, total: 200 }
                ],
                total: 200,
                reason: "استلام منتج غير مطابق للمواصفات"
            },
            {
                id: "RET-2024-002",
                invoiceId: 1003,
                supplier: "مستلزمات المكتبة",
                type: "damaged",
                date: "2024-01-18",
                status: "completed",
                items: [
                    { product: "طابعة ليزر", batch: "B006", quantity: 1, price: 2500, total: 2500 }
                ],
                total: 2500,
                reason: "تلف أثناء النقل"
            },
            {
                id: "RET-2024-003",
                invoiceId: 1001,
                supplier: "مورد التقنية المتطورة",
                type: "supplier_return",
                date: "2024-01-22",
                status: "pending",
                items: [
                    { product: "لابتوب ديل", batch: "B001", quantity: 1, price: 1500, total: 1500 }
                ],
                total: 1500,
                reason: "عيب في الشاشة"
            }
        ];

        // التهيئة
        document.addEventListener('DOMContentLoaded', function() {
            renderInvoicesTable();
            renderReturnsTable();
            updateStats();
            initCharts();
            
            // إضافة مستمع للبحث العام
            document.getElementById('globalSearch').addEventListener('input', function(e) {
                searchInvoices(e.target.value);
            });
            
            // تعيين تاريخ اليوم كافتراضي
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateTo').value = today;
            
            // تعيين تاريخ قبل شهر كافتراضي
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            document.getElementById('dateFrom').value = monthAgo.toISOString().split('T')[0];
        });

        // البحث في الفواتير
        function searchInvoices(query) {
            const searchResults = invoices.filter(invoice => {
                const searchLower = query.toLowerCase();
                return (
                    invoice.id.toString().includes(query) ||
                    invoice.supplier.toLowerCase().includes(searchLower) ||
                    invoice.supplierInvoice.toLowerCase().includes(searchLower)
                );
            });
            
            renderFilteredInvoices(searchResults);
            updateFilterStats(searchResults);
        }

        // تطبيق الفلاتر
        function applyFilters() {
            let filtered = [...invoices];
            const supplier = document.getElementById('supplierFilter').value;
            const status = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const searchQuery = document.getElementById('globalSearch').value;
            
            // فلترة حسب المورد
            if (supplier) {
                filtered = filtered.filter(invoice => {
                    if (supplier === "1") return invoice.supplier === "مورد التقنية المتطورة";
                    if (supplier === "2") return invoice.supplier === "شركة الأجهزة الحديثة";
                    if (supplier === "3") return invoice.supplier === "مستلزمات المكتبة";
                    return true;
                });
            }
            
            // فلترة حسب الحالة
            if (status) {
                if (status === "has_returns") {
                    filtered = filtered.filter(invoice => invoice.returned > 0);
                } else {
                    filtered = filtered.filter(invoice => invoice.status === status);
                }
            }
            
            // فلترة حسب التاريخ
            if (dateFrom) {
                filtered = filtered.filter(invoice => invoice.purchaseDate >= dateFrom);
            }
            if (dateTo) {
                filtered = filtered.filter(invoice => invoice.purchaseDate <= dateTo);
            }
            
            // تطبيق البحث إذا كان موجوداً
            if (searchQuery) {
                filtered = filtered.filter(invoice => {
                    const searchLower = searchQuery.toLowerCase();
                    return (
                        invoice.id.toString().includes(searchQuery) ||
                        invoice.supplier.toLowerCase().includes(searchLower) ||
                        invoice.supplierInvoice.toLowerCase().includes(searchLower)
                    );
                });
            }
            
            renderFilteredInvoices(filtered);
            updateFilterStats(filtered);
        }

        // تصفير الفلاتر
        function resetFilters() {
            document.getElementById('supplierFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('globalSearch').value = '';
            
            renderInvoicesTable();
            updateStats();
        }

        // تحديث الإحصائيات حسب البحث
        function updateFilterStats(filteredInvoices) {
            const total = filteredInvoices.reduce((sum, invoice) => sum + invoice.total, 0);
            const returnTotal = filteredInvoices.reduce((sum, invoice) => sum + invoice.returnValue, 0);
            const returnRate = total > 0 ? ((returnTotal / total) * 100).toFixed(1) : 0;
            const average = filteredInvoices.length > 0 ? (total / filteredInvoices.length).toFixed(0) : 0;
            
            document.getElementById('filteredCount').textContent = filteredInvoices.length;
            document.getElementById('filteredTotal').textContent = formatCurrency(total);
            document.getElementById('filteredAverage').textContent = formatCurrency(average);
            document.getElementById('filteredReturnRate').textContent = returnRate + '%';
            document.getElementById('displayedTotal').textContent = formatCurrency(total);
            document.getElementById('netPurchases').textContent = formatCurrency(total - returnTotal);
        }

        // تصدير البيانات
        function exportData() {
            const data = JSON.stringify(invoices, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'فواتير_المشتريات_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // التبديل بين التبويبات
        function switchTab(tabName) {
            // إخفاء كل المحتويات
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // إزالة النشاط من كل التبويبات
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إظهار المحتوى المطلوب
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // تفعيل التبويب المطلوب
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // إذا كانت تبويب التحليلات، تحديث المخططات
            if (tabName === 'analytics') {
                updateCharts();
            }
        }

        // فتح صفحة إدارة المرتجعات
        function openReturnsPage() {
            switchTab('returns');
        }

        // فتح صفحة التحليلات
        function openAnalyticsPage() {
            switchTab('analytics');
        }

        // دالة مساعدة للحصول على نص الحالة
        function getStatusBadge(status) {
            const badges = {
                pending: '<span class="badge badge-pending">قيد الانتظار</span>',
                fully_received: '<span class="badge badge-received">مستلمة</span>',
                partially_received: '<span class="badge badge-partial">مستلمة جزئياً</span>',
                cancelled: '<span class="badge badge-cancelled">ملغاة</span>',
                completed: '<span class="badge badge-received">مكتمل</span>'
            };
            return badges[status] || '<span class="badge badge-secondary">غير معروف</span>';
        }

        // دالة مساعدة لتنسيق العملة
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-EG', {
                style: 'currency',
                currency: 'EGP',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // تحديث الإحصائيات العامة
        function updateStats() {
            const totalPurchases = invoices.reduce((sum, invoice) => sum + invoice.total, 0);
            const totalReturns = invoices.reduce((sum, invoice) => sum + invoice.returnValue, 0);
            const pendingInvoices = invoices.filter(invoice => invoice.status === 'pending').length;
            const returnRate = totalPurchases > 0 ? ((totalReturns / totalPurchases) * 100).toFixed(1) : 0;
            
            document.getElementById('totalPurchases').textContent = formatCurrency(totalPurchases);
            document.getElementById('totalReturns').textContent = formatCurrency(totalReturns);
            document.getElementById('pendingInvoices').textContent = pendingInvoices + ' فواتير';
            document.getElementById('returnRate').textContent = returnRate + '%';
            document.getElementById('displayedTotal').textContent = formatCurrency(totalPurchases);
            document.getElementById('netPurchases').textContent = formatCurrency(totalPurchases - totalReturns);
        }

        // إظهار الفواتير بعد الفلترة
        function renderFilteredInvoices(filteredInvoices) {
            const tbody = document.getElementById('invoicesTable');
            tbody.innerHTML = '';
            
            if (filteredInvoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center" style="padding: 40px;">
                            <div style="color: var(--secondary); font-size: 16px;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="margin-bottom: 10px;">
                                    <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <div>لا توجد نتائج مطابقة للبحث</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredInvoices.forEach(invoice => {
                const statusBadge = getStatusBadge(invoice.status);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td><strong>${invoice.id}</strong></td>
                    <td><strong>${invoice.supplier}</strong></td>
                    <td>${invoice.purchaseDate}</td>
                    <td>${invoice.supplierInvoice}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div style="font-size: 12px;">
                            <div>${invoice.items} منتج</div>
                            <div style="color: var(--secondary);">${invoice.returned} مرتجع</div>
                        </div>
                    </td>
                    <td><strong>${formatCurrency(invoice.total)}</strong></td>
                    <td>
                        ${invoice.returned > 0 ? 
                            `<span class="badge badge-returned">${invoice.returned} مرتجع</span>` : 
                            '<span style="color: var(--secondary);">لا يوجد</span>'
                        }
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="viewInvoice(${invoice.id})">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                    <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                عرض
                            </button>
                            ${invoice.status === 'fully_received' ? `
                                <button class="btn btn-danger btn-sm" onclick="openReturnModal(${invoice.id})">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                        <path d="M9 17L4 12M4 12L9 7M4 12H20M13 12C13 15.3137 15.6863 18 19 18C20.6569 18 22 16.6569 22 15C22 13.3431 20.6569 12 19 12C17.3431 12 16 10.6569 16 9C16 7.34315 17.3431 6 19 6C20.6569 6 22 4.65685 22 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    مرتجع
                                </button>
                            ` : ''}
                            ${invoice.status === 'pending' ? `
                                <button class="btn btn-success btn-sm" onclick="receiveInvoice(${invoice.id})">
                                    استلام
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // دالة إظهار الفواتير الأصلية
        function renderInvoicesTable() {
            renderFilteredInvoices(invoices);
        }

        // فلترة المرتجعات
        function filterReturns() {
            let filtered = [...returns];
            const type = document.getElementById('returnTypeFilter').value;
            const status = document.getElementById('returnStatusFilter').value;
            const dateFrom = document.getElementById('returnDateFrom').value;
            const dateTo = document.getElementById('returnDateTo').value;
            
            if (type) {
                filtered = filtered.filter(ret => ret.type === type);
            }
            
            if (status) {
                filtered = filtered.filter(ret => ret.status === status);
            }
            
            if (dateFrom) {
                filtered = filtered.filter(ret => ret.date >= dateFrom);
            }
            
            if (dateTo) {
                filtered = filtered.filter(ret => ret.date <= dateTo);
            }
            
            renderReturnsTable(filtered);
            updateReturnsStats(filtered);
        }

        // تصفير فلترة المرتجعات
        function resetReturnFilters() {
            document.getElementById('returnTypeFilter').value = '';
            document.getElementById('returnStatusFilter').value = '';
            document.getElementById('returnDateFrom').value = '';
            document.getElementById('returnDateTo').value = '';
            
            renderReturnsTable();
            updateReturnsStats(returns);
        }

        // إظهار جدول المرتجعات
        function renderReturnsTable(returnsData = returns) {
            const tbody = document.getElementById('returnsTable');
            tbody.innerHTML = '';
            
            if (returnsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center" style="padding: 40px;">
                            <div style="color: var(--secondary); font-size: 16px;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" style="margin-bottom: 10px;">
                                    <path d="M21 21L15 15M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <div>لا توجد نتائج مطابقة للبحث</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            returnsData.forEach(ret => {
                const typeText = getReturnTypeText(ret.type);
                const statusBadge = getStatusBadge(ret.status);
                const totalItems = ret.items.reduce((sum, item) => sum + item.quantity, 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${ret.id}</strong></td>
                    <td>${ret.invoiceId}</td>
                    <td>${ret.supplier}</td>
                    <td><span class="badge" style="background: ${getReturnTypeColor(ret.type)}">${typeText}</span></td>
                    <td>${ret.date}</td>
                    <td>${totalItems} منتج</td>
                    <td><strong>${formatCurrency(ret.total)}</strong></td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="viewReturnDetails('${ret.id}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                    <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                تفاصيل
                            </button>
                            ${ret.status === 'pending' ? `
                                <button class="btn btn-success btn-sm" onclick="completeReturn('${ret.id}')">
                                    إكمال
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // تحديث إحصائيات المرتجعات
        function updateReturnsStats(returnsData = returns) {
            const totalValue = returnsData.reduce((sum, ret) => sum + ret.total, 0);
            const averageValue = returnsData.length > 0 ? (totalValue / returnsData.length).toFixed(0) : 0;
            
            // البحث عن المورد الأكثر مرتجعات
            const supplierReturns = returnsData.reduce((acc, ret) => {
                acc[ret.supplier] = (acc[ret.supplier] || 0) + ret.total;
                return acc;
            }, {});
            
            let topSupplier = 'لا يوجد';
            let topSupplierValue = 0;
            
            Object.entries(supplierReturns).forEach(([supplier, value]) => {
                if (value > topSupplierValue) {
                    topSupplierValue = value;
                    topSupplier = supplier;
                }
            });
            
            const pendingReturns = returnsData.filter(ret => ret.status === 'pending').length;
            
            document.getElementById('returnsTotalValue').textContent = formatCurrency(totalValue);
            document.getElementById('averageReturnValue').textContent = formatCurrency(averageValue);
            document.getElementById('topReturnSupplier').textContent = topSupplier;
            document.getElementById('pendingReturns').textContent = pendingReturns + ' مرتجعات';
        }

        // الحصول على لون نوع المرتجع
        function getReturnTypeColor(type) {
            const colors = {
                supplier_return: 'linear-gradient(135deg, #ef4444, #dc2626)',
                damaged: 'linear-gradient(135deg, #f59e0b, #d97706)',
                expired: 'linear-gradient(135deg, #6b7280, #4b5563)',
                wrong_item: 'linear-gradient(135deg, #8b5cf6, #7c3aed)',
                excess: 'linear-gradient(135deg, #0ea5e9, #0284c7)'
            };
            return colors[type] || 'linear-gradient(135deg, #6b7280, #4b5563)';
        }

        // عرض تفاصيل المرتجع
        function viewReturnDetails(returnId) {
            const ret = returns.find(r => r.id === returnId);
            if (!ret) return;
            
            const typeText = getReturnTypeText(ret.type);
            const statusText = ret.status === 'completed' ? 'مكتمل' : 
                             ret.status === 'pending' ? 'قيد المعالجة' : 'ملغي';
            
            const modal = document.getElementById('viewReturnModal');
            if (!modal) return;
            
            const modalContent = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>تفاصيل المرتجع</h2>
                        <button class="modal-close" onclick="closeModal('viewReturnModal')">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="return-details-grid">
                            <div class="detail-item">
                                <label>رقم المرتجع</label>
                                <div class="value">${ret.id}</div>
                            </div>
                            <div class="detail-item">
                                <label>الفاتورة الأصلية</label>
                                <div class="value">${ret.invoiceId}</div>
                            </div>
                            <div class="detail-item">
                                <label>المورد</label>
                                <div class="value">${ret.supplier}</div>
                            </div>
                            <div class="detail-item">
                                <label>نوع المرتجع</label>
                                <div class="value">${typeText}</div>
                            </div>
                            <div class="detail-item">
                                <label>تاريخ المرتجع</label>
                                <div class="value">${ret.date}</div>
                            </div>
                            <div class="detail-item">
                                <label>الحالة</label>
                                <div class="value">${statusText}</div>
                            </div>
                            <div class="detail-item">
                                <label>القيمة الإجمالية</label>
                                <div class="value">${formatCurrency(ret.total)}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h4 style="margin-bottom: 15px;">سبب المرتجع</h4>
                            <div style="background: var(--light); padding: 15px; border-radius: 8px; border-right: 4px solid var(--info);">
                                ${ret.reason}
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h4 style="margin-bottom: 15px;">المنتجات المرتجعة</h4>
                            <div class="return-items-list">
                                <div class="return-item-row header">
                                    <div>المنتج</div>
                                    <div>الدفعة</div>
                                    <div>الكمية</div>
                                    <div>السعر</div>
                                    <div>الإجمالي</div>
                                </div>
                                ${ret.items.map(item => `
                                    <div class="return-item-row">
                                        <div>${item.product}</div>
                                        <div>${item.batch}</div>
                                        <div>${item.quantity}</div>
                                        <div>${formatCurrency(item.price)}</div>
                                        <div><strong>${formatCurrency(item.total)}</strong></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="text-align: left; margin-top: 30px;">
                            <button class="btn btn-primary" onclick="closeModal('viewReturnModal')">إغلاق</button>
                            ${ret.status === 'pending' ? `
                                <button class="btn btn-success" onclick="completeReturn('${ret.id}')">
                                    إكمال المعالجة
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            modal.classList.add('active');
        }

        // إكمال معالجة المرتجع
        function completeReturn(returnId) {
            if (confirm('هل تريد تأكيد إكمال معالجة هذا المرتجع؟')) {
                const ret = returns.find(r => r.id === returnId);
                if (ret) {
                    ret.status = 'completed';
                    alert('تم إكمال معالجة المرتجع بنجاح');
                    renderReturnsTable();
                    updateReturnsStats();
                    closeModal('viewReturnModal');
                }
            }
        }

        // إغلاق المودال
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // تهيئة المخططات البيانية
        function initCharts() {
            // اتجاه المرتجعات الشهري
            const monthlyTrendsCtx = document.getElementById('monthlyTrendsChart').getContext('2d');
            window.monthlyTrendsChart = new Chart(monthlyTrendsCtx, {
                type: 'line',
                data: {
                    labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                    datasets: [{
                        label: 'قيمة المرتجعات',
                        data: [8750, 9200, 7800, 10200, 8900, 9500],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }, {
                        label: 'عدد المرتجعات',
                        data: [7, 9, 6, 11, 8, 10],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true,
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });

            // توزيع أنواع المرتجعات
            const returnsByTypeCtx = document.getElementById('returnsByTypeChart').getContext('2d');
            window.returnsByTypeChart = new Chart(returnsByTypeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['إرجاع للمورد', 'تلف في المخزن', 'منتهي الصلاحية', 'منتج خاطئ', 'كمية زائدة'],
                    datasets: [{
                        data: [35, 25, 15, 20, 5],
                        backgroundColor: [
                            '#ef4444',
                            '#f59e0b',
                            '#6b7280',
                            '#8b5cf6',
                            '#0ea5e9'
                        ],
                        borderWidth: 1,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'left',
                            rtl: true,
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    cutout: '60%'
                }
            });

            // المرتجعات حسب المورد
            const returnsBySupplierCtx = document.getElementById('returnsBySupplierChart').getContext('2d');
            window.returnsBySupplierChart = new Chart(returnsBySupplierCtx, {
                type: 'bar',
                data: {
                    labels: ['مورد التقنية', 'الأجهزة الحديثة', 'مستلزمات المكتبة', 'شركة الورق', 'معدات المكتب'],
                    datasets: [{
                        label: 'قيمة المرتجعات',
                        data: [3200, 4250, 2750, 1500, 800],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.7)',
                            'rgba(239, 68, 68, 0.7)',
                            'rgba(16, 185, 129, 0.7)',
                            'rgba(245, 158, 11, 0.7)',
                            'rgba(139, 92, 246, 0.7)'
                        ],
                        borderColor: [
                            '#3b82f6',
                            '#ef4444',
                            '#10b981',
                            '#f59e0b',
                            '#8b5cf6'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' ج.م';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });

            // مؤشرات الأداء الرئيسية
            const kpiCtx = document.getElementById('kpiChart').getContext('2d');
            window.kpiChart = new Chart(kpiCtx, {
                type: 'radar',
                data: {
                    labels: ['معدل المرتجعات', 'وقت المعالجة', 'رضا الموردين', 'دقة الفواتير', 'كفاءة المخزون'],
                    datasets: [{
                        label: 'الأداء الفعلي',
                        data: [85, 90, 88, 92, 87],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }, {
                        label: 'الهدف',
                        data: [95, 95, 95, 95, 95],
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true,
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // تحديث المخططات
        function updateCharts() {
            // يمكن إضافة تحديث ديناميكي للمخططات هنا
            if (window.monthlyTrendsChart) {
                window.monthlyTrendsChart.update();
            }
            if (window.returnsByTypeChart) {
                window.returnsByTypeChart.update();
            }
            if (window.returnsBySupplierChart) {
                window.returnsBySupplierChart.update();
            }
            if (window.kpiChart) {
                window.kpiChart.update();
            }
        }

        // دالة مساعدة للحصول على نص نوع المرتجع
        function getReturnTypeText(type) {
            const types = {
                supplier_return: 'إرجاع للمورد',
                damaged: 'تلف في المخزن',
                expired: 'منتهي الصلاحية',
                wrong_item: 'منتج خاطئ',
                excess: 'كمية زائدة'
            };
            return types[type] || 'غير محدد';
        }

        // الوظائف الأخرى من الكود الأصلي (لن تتغير)
        // ... (يتم الاحتفاظ بجميع الدوال الأصلية الأخرى كما هي)
    </script>


  <script>
        // Sample Data
        // const invoices = [
        //     {
        //         id: 1001,
        //         supplier: "مورد التقنية المتطورة",
        //         purchaseDate: "2024-01-15",
        //         supplierInvoice: "INV-2024-001",
        //         status: "fully_received",
        //         total: 25000,
        //         items: 5,
        //         returned: 2,
        //         batches: [
        //             { id: 1, product: "لابتوب ديل", batch: "B001", qty: 10, remaining: 10, cost: 1500, expiry: "2025-12-31" },
        //             { id: 2, product: "ماوس لاسلكي", batch: "B002", qty: 50, remaining: 48, cost: 100, expiry: "2026-06-30" },
        //             { id: 3, product: "كيبورد ميكانيكي", batch: "B003", qty: 20, remaining: 20, cost: 300, expiry: "2027-01-31" }
        //         ]
        //     },
        //     {
        //         id: 1002,
        //         supplier: "شركة الأجهزة الحديثة",
        //         purchaseDate: "2024-01-10",
        //         supplierInvoice: "INV-2024-002",
        //         status: "pending",
        //         total: 18000,
        //         items: 3,
        //         returned: 0,
        //         batches: [
        //             { id: 4, product: "شاشة 24 بوصة", batch: "B004", qty: 15, remaining: 15, cost: 1200, expiry: null },
        //             { id: 5, product: "سماعات رأس", batch: "B005", qty: 30, remaining: 30, cost: 200, expiry: null }
        //         ]
        //     },
        //     {
        //         id: 1003,
        //         supplier: "مستلزمات المكتبة",
        //         purchaseDate: "2024-01-05",
        //         supplierInvoice: "INV-2024-003",
        //         status: "fully_received",
        //         total: 32000,
        //         items: 8,
        //         returned: 1,
        //         batches: [
        //             { id: 6, product: "طابعة ليزر", batch: "B006", qty: 5, remaining: 4, cost: 2500, expiry: null },
        //             { id: 7, product: "حبر طابعة", batch: "B007", qty: 50, remaining: 49, cost: 150, expiry: "2024-12-31" }
        //         ]
        //     }
        // ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderInvoicesTable();
        });

        // Render Invoices Table
        function renderInvoicesTable() {
            const tbody = document.getElementById('invoicesTable');
            tbody.innerHTML = '';

            invoices.forEach(invoice => {
                const statusBadge = getStatusBadge(invoice.status);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${invoice.id}</td>
                    <td><strong>${invoice.supplier}</strong></td>
                    <td>${invoice.purchaseDate}</td>
                    <td>${invoice.supplierInvoice}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div style="font-size: 12px;">
                            <div>${invoice.items} منتج</div>
                            <div style="color: var(--secondary);">${invoice.returned} مرتجع</div>
                        </div>
                    </td>
                    <td><strong>${formatCurrency(invoice.total)}</strong></td>
                    <td>
                        ${invoice.returned > 0 ? 
                            `<span class="badge badge-returned">${invoice.returned} مرتجع</span>` : 
                            '<span style="color: var(--secondary);">لا يوجد</span>'
                        }
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="viewInvoice(${invoice.id})">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                    <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                عرض
                            </button>
                            ${invoice.status === 'fully_received' ? `
                                <button class="btn btn-danger btn-sm" onclick="openReturnModal(${invoice.id})">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                        <path d="M9 17L4 12M4 12L9 7M4 12H20M13 12C13 15.3137 15.6863 18 19 18C20.6569 18 22 16.6569 22 15C22 13.3431 20.6569 12 19 12C17.3431 12 16 10.6569 16 9C16 7.34315 17.3431 6 19 6C20.6569 6 22 4.65685 22 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    مرتجع
                                </button>
                            ` : ''}
                            ${invoice.status === 'pending' ? `
                                <button class="btn btn-success btn-sm" onclick="receiveInvoice(${invoice.id})">
                                    استلام
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Open Return Modal
        let currentInvoice = null;
        let selectedBatches = [];

        function openReturnModal(invoiceId) {
            currentInvoice = invoices.find(inv => inv.id === invoiceId);
            if (!currentInvoice) return;

            document.getElementById('returnModal').classList.add('active');
            renderBatchesList();
        }

        function closeReturnModal() {
            document.getElementById('returnModal').classList.remove('active');
            resetReturnForm();
        }

        function renderBatchesList() {
            const container = document.getElementById('batchesList');
            container.innerHTML = '';

            currentInvoice.batches.forEach(batch => {
                const card = document.createElement('div');
                card.className = 'return-item-card';
                card.innerHTML = `
                    <div class="item-header">
                        <h4 style="margin: 0;">${batch.product}</h4>
                        <label style="cursor: pointer;">
                            <input type="checkbox" class="batch-checkbox" value="${batch.id}" 
                                   onchange="toggleBatchSelection(${batch.id})">
                            اختر للإرجاع
                        </label>
                    </div>
                    <div class="item-info">
                        <div class="info-item">
                            <label>رقم الدفعة</label>
                            <div class="value">${batch.batch}</div>
                        </div>
                        <div class="info-item">
                            <label>السعر</label>
                            <div class="value">${formatCurrency(batch.cost)}</div>
                        </div>
                        <div class="info-item">
                            <label>الكمية المتاحة</label>
                            <div class="value">${batch.remaining} / ${batch.qty}</div>
                        </div>
                        <div class="info-item">
                            <label>تاريخ الصلاحية</label>
                            <div class="value">${batch.expiry || 'غير محدد'}</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function toggleBatchSelection(batchId) {
            const batch = currentInvoice.batches.find(b => b.id === batchId);
            const index = selectedBatches.findIndex(b => b.id === batchId);
            
            if (index === -1) {
                selectedBatches.push({
                    ...batch,
                    returnQty: 0,
                    reason: ''
                });
            } else {
                selectedBatches.splice(index, 1);
            }
        }

        function nextStep(step) {
            // Hide all steps
            document.querySelectorAll('.return-form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all steps
            document.querySelectorAll('.step').forEach(stepEl => {
                stepEl.classList.remove('active');
            });
            
            // Show current step
            document.getElementById(`step${step}Content`).classList.add('active');
            document.getElementById(`step${step}`).classList.add('active');
            
            // If going to step 2, render quantities
            if (step === 2) {
                renderQuantitiesStep();
            }
            
            // If going to step 3, render summary
            if (step === 3) {
                renderSummaryStep();
            }
        }

        function prevStep(step) {
            nextStep(step);
        }

        function renderQuantitiesStep() {
            const container = document.getElementById('quantitiesList');
            container.innerHTML = '';

            selectedBatches.forEach(batch => {
                const card = document.createElement('div');
                card.className = 'return-item-card';
                card.innerHTML = `
                    <h4 style="margin-bottom: 15px;">${batch.product} - ${batch.batch}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                        <div>
                            <label>الكمية المتاحة</label>
                            <div style="font-weight: 600; font-size: 18px;">${batch.remaining}</div>
                        </div>
                        <div>
                            <label>الكمية المرتجعة</label>
                            <div class="quantity-control">
                                <input type="number" class="qty-input" 
                                       value="${batch.returnQty}"
                                       min="0" max="${batch.remaining}"
                                       onchange="updateReturnQty(${batch.id}, this.value)">
                                <span class="qty-available">من ${batch.remaining}</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label>سبب إرجاع هذا المنتج</label>
                        <input type="text" class="form-control" 
                               placeholder="اكتب سبب محدد لهذا المنتج"
                               onchange="updateReturnReason(${batch.id}, this.value)">
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderSummaryStep() {
            const summary = document.getElementById('returnSummary');
            const returnType = document.getElementById('returnType').value;
            const returnReason = document.getElementById('returnReason').value;
            
            let totalQty = 0;
            let totalValue = 0;
            
            selectedBatches.forEach(batch => {
                totalQty += parseInt(batch.returnQty) || 0;
                totalValue += (parseInt(batch.returnQty) || 0) * batch.cost;
            });
            
            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>نوع المرتجع</label>
                        <div style="font-weight: 600;">${getReturnTypeText(returnType)}</div>
                    </div>
                    <div>
                        <label>السبب العام</label>
                        <div style="font-weight: 600;">${returnReason}</div>
                    </div>
                    <div>
                        <label>إجمالي الكمية</label>
                        <div style="font-weight: 600;">${totalQty} منتج</div>
                    </div>
                    <div>
                        <label>القيمة الإجمالية</label>
                        <div style="font-weight: 600;">${formatCurrency(totalValue)}</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h5 style="margin-bottom: 10px;">المنتجات المحددة:</h5>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        ${selectedBatches.map(batch => `
                            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                                <span>${batch.product} (${batch.batch})</span>
                                <span>${batch.returnQty} × ${formatCurrency(batch.cost)} = ${formatCurrency(batch.returnQty * batch.cost)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Set today's date
            document.getElementById('returnDate').valueAsDate = new Date();
        }

        function updateReturnQty(batchId, qty) {
            const batch = selectedBatches.find(b => b.id === batchId);
            if (batch) {
                const maxQty = batch.remaining;
                batch.returnQty = Math.min(Math.max(0, parseInt(qty) || 0), maxQty);
            }
        }

        function updateReturnReason(batchId, reason) {
            const batch = selectedBatches.find(b => b.id === batchId);
            if (batch) {
                batch.reason = reason;
            }
        }

        function submitReturn() {
            if (selectedBatches.length === 0) {
                alert('يرجى اختيار منتجات للإرجاع');
                return;
            }
            
            // Here you would normally send data to server
            const returnData = {
                invoiceId: currentInvoice.id,
                returnType: document.getElementById('returnType').value,
                reason: document.getElementById('returnReason').value,
                returnDate: document.getElementById('returnDate').value,
                items: selectedBatches.map(batch => ({
                    batchId: batch.id,
                    quantity: batch.returnQty,
                    reason: batch.reason
                }))
            };
            
            console.log('Submitting return:', returnData);
            
            // Show success message
            alert('تم إنشاء المرتجع بنجاح!');
            closeReturnModal();
            
            // Refresh the table
            renderInvoicesTable();
        }

        function resetReturnForm() {
            selectedBatches = [];
            document.getElementById('returnType').value = '';
            document.getElementById('returnReason').value = '';
            
            // Reset steps
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index === 0) step.classList.add('active');
            });
            
            document.querySelectorAll('.return-form-section').forEach((section, index) => {
                section.classList.remove('active');
                if (index === 0) section.classList.add('active');
            });
        }

        // Helper Functions
        function getStatusBadge(status) {
            const badges = {
                pending: '<span class="badge badge-pending">قيد الانتظار</span>',
                fully_received: '<span class="badge badge-received">مستلمة</span>',
                partially_received: '<span class="badge badge-partial">مستلمة جزئياً</span>',
                cancelled: '<span class="badge badge-cancelled">ملغاة</span>'
            };
            return badges[status] || '<span class="badge badge-secondary">غير معروف</span>';
        }

        function getReturnTypeText(type) {
            const types = {
                supplier_return: 'إرجاع للمورد',
                damaged: 'تلف في المخزن',
                expired: 'منتهي الصلاحية',
                wrong_item: 'منتج خاطئ',
                excess: 'كمية زائدة'
            };
            return types[type] || 'غير محدد';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-EG', {
                style: 'currency',
                currency: 'EGP'
            }).format(amount);
        }

        function viewInvoice(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            const modal = document.getElementById('viewInvoiceModal');
            const content = document.getElementById('invoiceDetails');
            
            content.innerHTML = `
                <div style="background: var(--light); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label>رقم الفاتورة</label>
                            <div style="font-weight: 600; font-size: 18px;">${invoice.id}</div>
                        </div>
                        <div>
                            <label>المورد</label>
                            <div style="font-weight: 600;">${invoice.supplier}</div>
                        </div>
                        <div>
                            <label>تاريخ الشراء</label>
                            <div style="font-weight: 600;">${invoice.purchaseDate}</div>
                        </div>
                        <div>
                            <label>الحالة</label>
                            <div>${getStatusBadge(invoice.status)}</div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px;">بنود الفاتورة</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--light);">
                                <th style="padding: 12px; text-align: right;">المنتج</th>
                                <th style="padding: 12px; text-align: center;">الدفعة</th>
                                <th style="padding: 12px; text-align: center;">الكمية</th>
                                <th style="padding: 12px; text-align: center;">المتاح</th>
                                <th style="padding: 12px; text-align: center;">السعر</th>
                                <th style="padding: 12px; text-align: center;">الصلاحية</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.batches.map(batch => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px;">${batch.product}</td>
                                    <td style="padding: 12px; text-align: center;">${batch.batch}</td>
                                    <td style="padding: 12px; text-align: center;">${batch.qty}</td>
                                    <td style="padding: 12px; text-align: center;">${batch.remaining}</td>
                                    <td style="padding: 12px; text-align: center;">${formatCurrency(batch.cost)}</td>
                                    <td style="padding: 12px; text-align: center;">${batch.expiry || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div style="text-align: left; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="closeViewModal()">إغلاق</button>
                    ${invoice.status === 'fully_received' ? `
                        <button class="btn btn-danger" onclick="openReturnModal(${invoice.id}); closeViewModal()">
                            إنشاء مرتجع
                        </button>
                    ` : ''}
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeViewModal() {
            document.getElementById('viewInvoiceModal').classList.remove('active');
        }

        function receiveInvoice(invoiceId) {
            if (confirm('هل تريد تأكيد استلام هذه الفاتورة بالكامل؟')) {
                // Here you would normally send request to server
                alert('تم استلام الفاتورة بنجاح');
                renderInvoicesTable();
            }
        }

        function openReturnsPage() {
            alert('سيتم فتح صفحة إدارة المرتجعات');
            // window.location.href = 'purchase_returns.php';
        }
    </script>
</body>
</html>