بعد تحليل الكود المقدم، إليك تحليل منطق التطبيق (Business Logic) بالتفصيل:

## 1. **شرح منطق التطبيق العام**

### **الوظيفة الأساسية للتطبيق:**
نظام متكامل لإدارة العملاء يشمل:
- إدارة الفواتير (إنشاء، سداد، تتبع حالة)
- إدارة الشغلانات (مشاريع/طلبات عمل)
- نظام محفظة العملاء (إيداعات، مدفوعات)
- إدارة المرتجعات (كلي/جزئي)
- كشف حساب متكامل

### **Workflow النظام:**
1. **عملية البيع**: إنشاء فاتورة → إضافة أصناف → تحديد طريقة الدفع → تحديث المخزون
2. **عملية السداد**: اختيار الفواتير/الشغلانات → إدخال المبالغ → اختيار طرق الدفع → تحديث الأرصدة
3. **عملية الإرجاع**: اختيار الفاتورة → تحديد الأصناف المرتجعة → حساب التأثير المالي → معالجة الرد
4. **إدارة الشغلانات**: إنشاء شغلانة → ربط الفواتير → تتبع التقدم → السداد الجماعي

## 2. **تحليل تدفق البيانات (Data Flow)**

### **من أين تأتي البيانات:**
- بيانات أولية مخزنة في `AppData`
- إدخال المستخدم عبر النماذج (Modals)
- نتائج الفلاتر والبحث

### **مسار البيانات خطوة بخطوة:**

#### **عند إضافة صنف:**
1. المستخدم يبحث عن المنتج
2. النظام يتحقق من الكمية المتاحة
3. يتم حساب الإجمالي الفوري
4. تحديث المخزون الافتراضي

#### **عند تغيير السعر:**
1. إعادة حساب إجمالي الصنف
2. إعادة حساب إجمالي الفاتورة
3. تحديث المتبقي تلقائياً

#### **عند الدفع:**
```
البيانات → [تحميل الفواتير غير المسددة] → [اختيار الفواتير] → [إدخال المبالغ] → [اختيار طرق الدفع] → [التحقق من التوازن] → [تحديث الفواتير] → [تحديث المحفظة] → [تحديث الإحصائيات]
```

#### **عند المرتجع:**
```
اختيار الفاتورة → [فحص حالة الدفع] → [اختيار الأصناف] → [حساب المبلغ] → [تحديد طريقة الرد] → [تحديث الفاتورة] → [تحديث المخزون] → [تحديث المحفظة إن لزم]
```

#### **في محفظة العميل:**
1. الإيداع: زيادة الرصيد + تسجيل حركة
2. السداد: خصم من الرصيد + تسجيل حركة
3. المرتجع: إضافة للرصيد + تسجيل حركة

## 3. **تحليل كل Logic Block في الـ JS**

### **AppData (بيانات التطبيق):**
- **النية**: تخزين حالة التطبيق الحالية
- **التأثير**: يعتبر المصدر الوحيد للحقيقة (Single Source of Truth)
- **المرحلة**: تخزين وإدارة البيانات

### **CustomerManager (مدير العملاء):**
- **الوظيفة**: تحديث معلومات العميل وحساب أرصدته
- **المنطق**: ربط بيانات العميل بالمعاملات المالية
- **التأثير**: يؤثر على جميع العمليات المالية للعميل

### **InvoiceManager (مدير الفواتير):**
- **الوظيفة**: إدارة دورة حياة الفاتورة
- **المنطق الأساسي**:
  - تصفية وعرض الفواتير
  - تحديث حالة الفاتورة بعد السداد/المرتجع
  - حساب الكميات المتاحة للإرجاع
- **التأثير**: يؤثر على المخزون، الأرصدة، الإحصائيات

### **PaymentManager (مدير المدفوعات):**
- **الوظيفة**: معالجة عمليات السداد المعقدة
- **المنطق الهام**:
  - دعم تعدد طرق الدفع
  - التحقق من توازن المدفوعات
  - التوزيع التلقائي للمبالغ
  - معالجة السداد للشغلانات
- **التأثير المالي**: تحديث الفواتير، المحفظة، الإحصائيات

### **ReturnManager (مدير المرتجعات):**
- **الوظيفة**: إدارة عمليات الإرجاع بأنواعها
- **المنطق المعقد**: حساب التأثير المالي بناءً على:
  - طريقة الدفع الأصلية
  - المبلغ المدفوع
  - المبلغ المتبقي
  - نوع الإرجاع (كلي/جزئي)

### **CustomReturnManager (مدير المرتجعات المخصصة):**
- **الوظيفة**: معالجة المرتجعات على مستوى الصنف
- **المنطق**: 
  - التحقق من الكمية المتاحة للإرجاع
  - حساب التأثير المالي التفصيلي
  - عرض خيارات رد المبالغ

### **WalletManager (مدير المحفظة):**
- **الوظيفة**: تتبع حركات المحفظة
- **المنطق**: 
  - حساب الرصيد قبل وبعد كل حركة
  - ربط الحركات بالمعاملات (سداد، مرتجع، إيداع)
  - توفير كشف حساب

### **WorkOrderManager (مدير الشغلانات):**
- **الوظيفة**: إدارة المشاريع/الطلبات
- **المنطق**: 
  - ربط الفواتير بالشغلانة
  - حساب إجمالي المطلوب والمسدد
  - تتبع حالة الشغلانة

## 4. **تحليل الحسابات**

### **حساب إجمالي الفاتورة:**
```
إجمالي الفاتورة = مجموع (كمية الصنف × سعر الصنف) لكل الأصناف
```

### **حساب المتبقي:**
```
المتبقي = الإجمالي - المدفوع
```

### **حساب المرتجع:**
```
مبلغ المرتجع = مجموع (كمية مرتجعة × سعر الصنف)
```

### **حساب التأثير المالي للإرجاع:**

#### **للدفع النقدي/المحفظة:**
```
إذا (مبلغ المرتجع ≤ المدفوع) {
    يُرد كامل المبلغ للعميل
} وإلا {
    يُرد المدفوع فقط
}
```

#### **للدفع الآجل:**
```
إذا (مبلغ المرتجع ≤ المتبقي) {
    يخصم من المتبقي فقط
} وإلا {
    يخصم المتبقي بالكامل + يُرد الفرق للعميل
}
```

### **حساب رصيد المحفظة:**
```
الرصيد الجديد = الرصيد القديم ± المبلغ (إيداع + / سداد - / مرتجع +)
```

### **حساب حالة الفاتورة:**
```
إذا (المدفوع = الإجمالي) ← حالة: مسلم
وإلا إذا (المدفوع > 0) ← حالة: جزئي
وإلا إذا (المدفوع = 0) ← حالة: مؤجل
إذا (كل الأصناف مرتجعة) ← حالة: مرتجع
```

## 5. **تحليل قواعد العمل (Business Rules)**

### **قواعد إضافة الأصناف:**
- يجب أن يكون الصنف موجوداً في المخزون
- الكمية المطلوبة ≤ الكمية المتاحة
- لا يمكن إضافة صنف مرتجع كلياً

### **قواعد المنع من البيع:**
- مخزون الصنف = 0
- العميل لديه مديونية تتجاوز الحد المسموح

### **شروط قبول المرتجع:**
1. **الوقت**: خلال فترة السماح بالإرجاع
2. **الكمية**: الكمية المرتجعة ≤ الكمية المباعة - المرتجعة سابقاً
3. **الحالة**: المنتج في حالة قابلة للإرجاع
4. **المستندات**: وجود الفاتورة الأصلية

### **قواعد Batch Allocation:**
- غير مطبق في النظام الحالي

### **التحقق من الكمية المتاحة:**
```
الكمية المتاحة للإرجاع = الكمية المباعة - الكمية المرتجعة سابقاً
```

## 6. **تحليل العلاقات بين أجزاء النظام**

### **العلاقة بين الفاتورة والمخزون:**
- عند البيع: خصم الكمية من المخزون
- عند المرتجع: إضافة الكمية للمخزون
- النظام يحتفظ بكمية مرتجعة لكل صنف

### **العلاقة بين المدفوعات والفاتورة:**
- المدفوعات تخفض المتبقي
- تغيير حالة الفاتورة بناءً على نسبة السداد
- تحديث تاريخ آخر سداد

### **العلاقة بين المرتجع والمدفوعات:**
- المرتجع قد يؤدي إلى رد أموال للعميل
- التأثير يختلف حسب طريقة الدفع الأصلية
- تحديث المدفوع والمتبقي بعد المرتجع

### **العلاقة بين المحفظة والعميل:**
- كل عميل لديه محفظة مستقلة
- المحفظة تستخدم للسداد والمرتجعات
- يمكن تحويل من المحفظة للرصيد

### **حساب الحالة النهائية للفاتورة:**
```
تحدد بناءً على:
1. نسبة السداد (0%، جزئي، 100%)
2. وجود مرتجعات
3. حالة الأصناف (مرتجع كلي/جزئي)
```

## 7. **ملخص منطق النظام الكامل**

### **"كيف يفكر النظام":**
النظام يعامل العميل كمركز لجميع المعاملات، حيث:
1. **كل عملية مالية ترتبط بالعميل** مباشرة
2. **الفاتورة هي الوحدة الأساسية** للبيع والمرتجع
3. **الشغلانة هي مجموعة فواتير** تخدم مشروعاً واحداً
4. **المحفظة هي الحساب الجاري** للعميل
5. **المرتجع معاملة معكوسة** تؤثر على جميع الجوانب

### **سيناريو البيع الكامل:**
```
البداية: [عميل جديد] → [إنشاء فاتورة] → [إضافة أصناف] → [تحديد طريقة الدفع]
المتوسط: [تخفيض المخزون] → [تحديث أرصدة العميل] → [تسجيل الحركة]
النهاية: [فاتورة مؤجلة/مسددة] → [كشف حساب] → [متابعة المديونية]
```

### **سيناريو المرتجع الكامل:**
```
البداية: [طلب مرتجع] → [فحص الفاتورة] → [تحقق من الشروط]
الحساب: [تحديد الأصناف] → [حساب المبلغ] → [تحديد طريقة الرد]
التنفيذ: [تحديث الفاتورة] → [رد المبلغ] → [تحديث المخزون] → [تسجيل الحركة]
