# ØªÙ‚Ø±ÙŠØ± ÙƒØ§Ù…Ù„: Ø³Ù„ÙˆÙƒ ÙƒÙ„ Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹

ÙƒØ®Ø¨ÙŠØ± ÙÙŠ Ø£Ù†Ø¸Ù…Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù† ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§ØªØŒ Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ø³Ù„ÙˆÙƒ ÙƒÙ„ Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ù…ÙƒÙ†Ø© Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹.

## ğŸ“Š **Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„ÙƒÙ„ Ø¬Ø¯ÙˆÙ„**

### **1. Ø¬Ø¯ÙˆÙ„ `batches` (Ø§Ù„Ø¯ÙÙØ¹Ø§Øª)**

#### **Ø£- Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©):**
```sql
-- ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø¯ÙØ¹Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡:
-- Ø­Ø§Ù„Ø©: Ø´Ø±Ø§Ø¡ 10 ÙˆØ­Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬ X Ù…Ù† Ø¯ÙØ¹ØªÙŠÙ† (5 Ù…Ù† ÙƒÙ„ Ø¯ÙØ¹Ø©)
UPDATE batches SET remaining = remaining - 5 WHERE id = 1;
UPDATE batches SET remaining = remaining - 5 WHERE id = 2;

-- Ø¥Ø°Ø§ ÙˆØµÙ„Øª remaining Ø¥Ù„Ù‰ 0:
UPDATE batches SET status = 'consumed' WHERE remaining = 0;
```

#### **Ø¨- Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹:**

| Ø§Ù„Ø­Ø§Ù„Ø© | Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ `batches` | Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‚ØªØ±Ø­ |
|--------|---------------------|---------------|
| **Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù†Ø¯ Ø¹Ø§Ø¯ÙŠ** | Ø²ÙŠØ§Ø¯Ø© `remaining` ÙÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© | `UPDATE batches SET remaining = remaining + @qty WHERE id = @batch_id` |
| **Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù†Ø¯ Ø¹Ù„ÙŠÙ‡ Ø®ØµÙ…** | Ù†ÙØ³ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ù„Ø§ ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†) | `UPDATE batches SET remaining = remaining + @qty WHERE id = @batch_id` |
| **Ø¥Ø±Ø¬Ø§Ø¹ ÙØ§ØªÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø©** | Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª | `UPDATE batches SET remaining = remaining + sia.qty FROM sale_item_allocations WHERE...` |
| **Ø¯ÙØ¹Ø© ÙƒØ§Ù†Øª `consumed`** | ØªØºÙŠÙŠØ± `status` Ø¥Ù„Ù‰ `active` | `UPDATE batches SET status='active', remaining=@qty WHERE id=@batch_id` |

**Ø§Ù„ØªÙØ§ØµÙŠÙ„:**
```sql
-- Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©
UPDATE batches 
SET 
    remaining = remaining + @return_qty,
    status = CASE 
        WHEN (remaining + @return_qty) > 0 THEN 'active'
        ELSE status
    END,
    updated_at = NOW(),
    revert_reason = CONCAT('Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ù† ÙØ§ØªÙˆØ±Ø© #', @invoice_id)
WHERE id = @batch_id;
```

### **2. Ø¬Ø¯ÙˆÙ„ `sale_item_allocations` (ØªØ®ØµÙŠØµØ§Øª Ø§Ù„Ø¨ÙŠØ¹)**

#### **Ø£- Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø§Ø¡:**
```sql
-- ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ù„ÙƒÙ„ ØªØ®ØµÙŠØµ
INSERT INTO sale_item_allocations 
(sale_item_id, batch_id, qty, unit_cost, line_cost, created_by)
VALUES 
(@item_id, 1, 5, 10.00, 50.00, @user_id),
(@item_id, 2, 5, 12.00, 60.00, @user_id);
```

#### **Ø¨- Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹:**

| Ø§Ù„Ø­Ø§Ù„Ø© | Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ `sale_item_allocations` | Ø§Ù„Ù…Ù†Ø·Ù‚ |
|--------|-----------------------------------|--------|
| **Ø¥Ø±Ø¬Ø§Ø¹ Ø¬Ø²Ø¦ÙŠ** | Ø¥Ù†Ø´Ø§Ø¡ ØªØ®ØµÙŠØµØ§Øª Ø¹ÙƒØ³ÙŠØ© (Ø³Ø§Ù„Ø¨Ø©) | ÙƒÙ…ÙŠØ© Ø³Ø§Ù„Ø¨Ø© Ù„Ù†ÙØ³ `batch_id` |
| **Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØ§Ù…Ù„** | Ø¥Ù†Ø´Ø§Ø¡ ØªØ®ØµÙŠØµØ§Øª Ø¹ÙƒØ³ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ®ØµÙŠØµØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© | Ù†Ø¤Ø±Ø´Ù ÙˆÙ„Ø§ Ù†Ø­Ø°Ù |
| **Ø­ÙØ¸ Ø§Ù„ØªØ§Ø±ÙŠØ®** | Ù„Ø§ Ù†Ø­Ø°Ù Ø§Ù„ØªØ®ØµÙŠØµØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© | Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ |

**Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù‚ØªØ±Ø­:**
```sql
-- Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹ (Ù…Ù‚ØªØ±Ø­)
ALTER TABLE sale_item_allocations 
ADD COLUMN return_id INT NULL,
ADD COLUMN is_return BOOLEAN DEFAULT FALSE;

-- Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹: Ø¥Ù†Ø´Ø§Ø¡ ØªØ®ØµÙŠØµØ§Øª Ø¹ÙƒØ³ÙŠØ©
INSERT INTO sale_item_allocations 
(sale_item_id, batch_id, qty, unit_cost, line_cost, created_by, return_id, is_return)
VALUES 
(@sale_item_id, @batch_id, -@return_qty, @unit_cost, -(@unit_cost * @return_qty), @user_id, @return_id, TRUE);
```

### **3. Ø¬Ø¯ÙˆÙ„ `invoices_out` (Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ØµØ§Ø¯Ø±Ø©)**

#### **Ø£- Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹:**

| Ø§Ù„Ø­Ø§Ù„Ø© | Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ `invoices_out` | Ø§Ù„ØªØ£Ø«ÙŠØ± |
|--------|--------------------------|---------|
| **Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù†Ø¯ ÙˆØ§Ø­Ø¯** | ØªØ­Ø¯ÙŠØ« `total_cost`, `profit_amount` | Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ |
| **Ø¥Ø±Ø¬Ø§Ø¹ ÙØ§ØªÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø©** | ØªØºÙŠÙŠØ± `delivered` Ø¥Ù„Ù‰ `reverted` | ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© |
| **ØªØ£Ø«ÙŠØ± Ù…Ø§Ù„ÙŠ** | `total_cost` ÙŠÙ‚Ù„ØŒ `profit_amount` ÙŠØªØºÙŠØ± | Ø­Ø³Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ |

**Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©:**
```sql
-- Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹
SET @return_cost = (
    SELECT SUM(sia.line_cost * (ri.quantity / sia.qty))
    FROM return_items ri
    JOIN sale_item_allocations sia ON JSON_CONTAINS(ri.batch_allocations, CAST(sia.batch_id AS JSON))
    WHERE ri.return_id = @return_id
);

-- ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©
UPDATE invoices_out 
SET 
    total_cost = total_cost - @return_cost,
    profit_amount = total_after_discount - (total_cost - @return_cost),
    delivered = CASE 
        WHEN @is_full_return THEN 'reverted'
        WHEN delivered = 'yes' AND @has_partial_return THEN 'partial'
        ELSE delivered
    END,
    updated_at = NOW(),
    updated_by = @user_id
WHERE id = @invoice_id;
```

### **4. Ø¬Ø¯ÙˆÙ„ `invoice_out_items` (Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©)**

#### **Ø£- Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹:**
- `returned_quantity`: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©
- `return_flag`: ØªÙ„Ù‚Ø§Ø¦ÙŠ (1 Ø¥Ø°Ø§ `returned_quantity = quantity`)
- `available_for_return`: ØªÙ„Ù‚Ø§Ø¦ÙŠ (`quantity - returned_quantity`)

#### **Ø¨- Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹:**

| Ø§Ù„Ø­Ø§Ù„Ø© | Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ `invoice_out_items` | Ø§Ù„ÙƒÙˆØ¯ |
|--------|-------------------------------|-------|
| **Ø¥Ø±Ø¬Ø§Ø¹ Ø¬Ø²Ø¦ÙŠ** | Ø²ÙŠØ§Ø¯Ø© `returned_quantity` | `UPDATE ... SET returned_quantity = returned_quantity + @qty` |
| **Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¨Ù†Ø¯** | `returned_quantity = quantity` | `UPDATE ... SET returned_quantity = quantity` |
| **Ø¨Ù†Ø¯ Ø¹Ù„ÙŠÙ‡ Ø®ØµÙ…** | Ù†ÙØ³ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Ø§Ù„Ø®ØµÙ… Ù„Ø§ ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…ÙŠØ©) | Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø³Ø¹Ø± |

**Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„:**
```sql
-- ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
UPDATE invoice_out_items 
SET 
    returned_quantity = returned_quantity + @return_qty,
    updated_at = NOW()
WHERE id = @invoice_item_id;

-- Ù…Ù„Ø§Ø­Ø¸Ø©: return_flag Ùˆ available_for_return ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ù…Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
```

### **5. Ø¬Ø¯ÙˆÙ„ `returns` Ùˆ `return_items` (Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹)**

#### **Ø£- Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹:**
```sql
-- ÙÙŠ returns
INSERT INTO returns 
(invoice_id, customer_id, total_amount, return_type, 
 status, reason, created_by, notes)
VALUES 
(@invoice_id, @customer_id, @total_return_amount, 
 @return_type, 'completed', @reason, @user_id, @notes);

-- ÙÙŠ return_items Ù„ÙƒÙ„ Ø¨Ù†Ø¯
INSERT INTO return_items 
(return_id, invoice_item_id, product_id, quantity, 
 return_price, total_amount, batch_allocations, status)
VALUES 
(@return_id, @item_id, @product_id, @qty,
 @calculated_price, @total_item_amount, @batch_json, 'restocked');
```

#### **Ø¨- `batch_allocations` ÙÙŠ JSON:**
```json
{
  "allocations": [
    {
      "batch_id": 1,
      "qty": 3,
      "unit_cost": 10.00,
      "original_allocation_id": 101
    },
    {
      "batch_id": 2,
      "qty": 2,
      "unit_cost": 12.00,
      "original_allocation_id": 102
    }
  ]
}
```

### **6. Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©**

#### **Ø£- Ø¬Ø¯ÙˆÙ„ `customers`:**

| Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© | Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ `customers` | Ø§Ù„Ù…Ù†Ø·Ù‚ |
|--------------|------------------------|--------|
| **ÙØ§ØªÙˆØ±Ø© Ù…Ø¤Ø¬Ù„Ø©** | ØªÙ‚Ù„ÙŠÙ„ `balance` (Ø§Ù„Ù…Ø¯ÙŠÙ†) | Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙƒØ§Ù† Ù…Ø¯ÙŠÙ†Ø§Ù‹ØŒ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ ÙŠÙ‚Ù„Ù„ Ø¯ÙŠÙ†Ù‡ |
| **ÙØ§ØªÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø©** | Ø²ÙŠØ§Ø¯Ø© `wallet` (Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ù…Ø­ÙØ¸Ø©) | Ø£Ùˆ Ù„Ø§ ØªØºÙŠÙŠØ± (Ø¥Ø°Ø§ Ø£Ø®Ø° Ù†Ù‚Ø¯ÙŠ) |
| **ÙØ§ØªÙˆØ±Ø© Ø¬Ø²Ø¦ÙŠØ©** | ØªÙ‚Ù„ÙŠÙ„ `balance` ÙˆØ¬Ø²Ø¡ `wallet` | Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº |

**Ø§Ù„ÙƒÙˆØ¯:**
```sql
-- ÙØ§ØªÙˆØ±Ø© Ù…Ø¤Ø¬Ù„Ø©: ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†
UPDATE customers 
SET balance = balance - @return_amount
WHERE id = @customer_id;

-- ÙØ§ØªÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø© (Ù…Ø­ÙØ¸Ø©): Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©
UPDATE customers 
SET wallet = wallet + @return_amount
WHERE id = @customer_id;

-- ÙØ§ØªÙˆØ±Ø© Ø¬Ø²Ø¦ÙŠØ©: ÙƒÙ„Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ÙŠÙ†
UPDATE customers 
SET 
    balance = balance - @balance_adjustment,
    wallet = wallet + @wallet_adjustment
WHERE id = @customer_id;
```

#### **Ø¨- Ø¬Ø¯ÙˆÙ„ `customer_transactions`:**

```sql
-- Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
INSERT INTO customer_transactions 
(customer_id, transaction_type, amount, description,
 invoice_id, return_id, balance_before, balance_after,
 wallet_before, wallet_after, created_by)
VALUES 
(@customer_id, 'return', -@amount, 
 CONCAT('Ø¥Ø±Ø¬Ø§Ø¹ ÙØ§ØªÙˆØ±Ø© #', @invoice_id),
 @invoice_id, @return_id, @old_balance, @new_balance,
 @old_wallet, @new_wallet, @user_id);
```

#### **Ø¬- Ø¬Ø¯ÙˆÙ„ `invoice_payments` (Ù„Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù†Ù‚Ø¯ÙŠ):**

```sql
-- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù†Ù‚Ø¯ÙŠ Ù…Ù† ÙØ§ØªÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø©
INSERT INTO invoice_payments 
(invoice_id, payment_amount, payment_method, 
 payment_date, notes, created_by)
VALUES 
(@invoice_id, -@return_amount, 'cash', 
 NOW(), 'Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù†Ù‚Ø¯ÙŠ Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹', @user_id);
```

#### **Ø¯- Ø¬Ø¯ÙˆÙ„ `wallet_transactions`:**

```sql
-- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¹Ø¨Ø± Ø§Ù„Ù…Ø­ÙØ¸Ø©
INSERT INTO wallet_transactions 
(customer_id, type, amount, description,
 wallet_before, wallet_after, created_by)
VALUES 
(@customer_id, 'refund', @return_amount,
 CONCAT('Ø¥Ø±Ø¬Ø§Ø¹ ÙØ§ØªÙˆØ±Ø© #', @invoice_id),
 @old_wallet, @new_wallet, @user_id);
```

## ğŸ¯ **Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø§Ù„ØªÙØµÙŠÙ„**

### **Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 1: Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù†Ø¯ Ø¹Ø§Ø¯ÙŠ (Ø¨Ø¯ÙˆÙ† Ø®ØµÙ…)**

**Ù…Ø«Ø§Ù„:** Ø¨Ù†Ø¯: 10 ÙˆØ­Ø¯Ø§ØªØŒ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© 20ØŒ Ø§Ù„ØªÙƒÙ„ÙØ© 15

**Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„:**

| Ø§Ù„Ø¬Ø¯ÙˆÙ„ | Ø§Ù„ØªØºÙŠÙŠØ± | Ø§Ù„Ù‚ÙŠÙ…Ø© |
|--------|---------|--------|
| `batches` | `remaining` ÙŠØ²ÙŠØ¯ | +10 ÙˆØ­Ø¯Ø§Øª |
| `invoice_out_items` | `returned_quantity` ÙŠØ²ÙŠØ¯ | +10 |
| `invoices_out` | `total_cost` ÙŠÙ‚Ù„ | -150 (10Ã—15) |
| `invoices_out` | `profit_amount` ÙŠØªØºÙŠØ± | +150 (ÙŠÙ‚Ù„ Ø§Ù„Ø±Ø¨Ø­) |
| `returns` | Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ | Ù…Ø¨Ù„Øº 200 |
| `return_items` | Ø³Ø¬Ù„ Ø§Ù„Ø¨Ù†Ø¯ | ÙƒÙ…ÙŠØ© 10 |
| `customers` | Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹ | ØªÙˆØ¶ÙŠØ­ Ø£Ø¯Ù†Ø§Ù‡ |

**Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„:**
```sql
-- 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
SELECT * FROM invoice_out_items WHERE id = @item_id;
SELECT * FROM sale_item_allocations WHERE sale_item_id = @item_id;

-- 2. Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
INSERT INTO returns (...) VALUES (...);
SET @return_id = LAST_INSERT_ID();

-- 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (batches)
UPDATE batches b
JOIN sale_item_allocations sia ON b.id = sia.batch_id
SET 
    b.remaining = b.remaining + (@return_qty * (sia.qty / @total_item_qty)),
    b.status = CASE 
        WHEN b.remaining > 0 THEN 'active'
        ELSE b.status
    END
WHERE sia.sale_item_id = @item_id;

-- 4. ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
UPDATE invoice_out_items 
SET returned_quantity = returned_quantity + @return_qty 
WHERE id = @item_id;

-- 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©
UPDATE invoices_out 
SET 
    total_cost = total_cost - (@return_qty * @cost_price),
    profit_amount = total_after_discount - (total_cost - (@return_qty * @cost_price))
WHERE id = @invoice_id;

-- 6. Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹)
-- ... (Ø³ÙŠØªÙ… ØªÙˆØ¶ÙŠØ­Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
```

### **Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 2: Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù†Ø¯ Ø¹Ù„ÙŠÙ‡ Ø®ØµÙ…**

**Ù…Ø«Ø§Ù„:** Ø¨Ù†Ø¯: 10 ÙˆØ­Ø¯Ø§ØªØŒ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© 20ØŒ Ø®ØµÙ… 10%ØŒ ØµØ§ÙÙŠ 180

**Ø§Ù„ØªØ­Ø¯ÙŠ:** ÙƒÙ… Ù†Ø±Ø¬Ø¹ Ù„Ù„Ø¹Ù…ÙŠÙ„ØŸ 200 Ø£Ù… 180ØŸ

**Ø§Ù„Ø­Ù„:** Ù†Ø±Ø¬Ø¹ **180** (Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…)

**Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ø®ØªÙ„Ù:**

| Ø§Ù„Ø¬Ø¯ÙˆÙ„ | Ø§Ù„ÙØ±Ù‚ Ø¹Ù† Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø¹Ø§Ø¯ÙŠ |
|--------|----------------------|
| `return_items.return_price` | 18 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 20 |
| `return_items.total_amount` | 180 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 200 |
| `returns.total_amount` | 180 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 200 |
| **Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù…ØªØ·Ø§Ø¨Ù‚** ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„ØªÙƒØ§Ù„ÙŠÙ | |

**Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø®ØµÙ…:**
```sql
-- Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
SET @item_discount_ratio = 1 - (@discount_amount / @total_before_discount);
SET @unit_price_after_discount = @selling_price * @item_discount_ratio;

-- Ø£Ùˆ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©
SET @unit_price_after_discount = @total_after_discount / @quantity;

-- ØªØ³Ø¬ÙŠÙ„ ÙÙŠ return_items
INSERT INTO return_items 
(return_id, invoice_item_id, product_id, quantity, 
 return_price, total_amount, batch_allocations)
VALUES 
(@return_id, @item_id, @product_id, @return_qty,
 @unit_price_after_discount, 
 @unit_price_after_discount * @return_qty,
 @batch_json);
```

### **Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 3: Ø¥Ø±Ø¬Ø§Ø¹ ÙØ§ØªÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø©**

**Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„:**

| Ø§Ù„Ø¬Ø¯ÙˆÙ„ | Ø§Ù„ØªØºÙŠÙŠØ± | Ø§Ù„Ù…Ù†Ø·Ù‚ |
|--------|---------|--------|
| `invoices_out.delivered` | `'reverted'` | ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© |
| ÙƒÙ„ `invoice_out_items` | `returned_quantity = quantity` | Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØ§Ù…Ù„ Ù„ÙƒÙ„ Ø¨Ù†Ø¯ |
| ÙƒÙ„ `batches` Ù…Ø±ØªØ¨Ø·Ø© | Ø¥Ø¹Ø§Ø¯Ø© ÙƒÙ„ Ø§Ù„ÙƒÙ…ÙŠØ§Øª | Ø­Ø³Ø¨ ØªØ®ØµÙŠØµØ§Øª Ø§Ù„Ø¨ÙŠØ¹ |
| `sale_item_allocations` | ØªØ®ØµÙŠØµØ§Øª Ø¹ÙƒØ³ÙŠØ© ÙƒØ§Ù…Ù„Ø© | Ù„ÙƒÙ„ ØªØ®ØµÙŠØµ Ø£ØµÙ„ÙŠ |
| `returns.return_type` | `'full'` | Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØ§Ù…Ù„ |

**Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„:**
```sql
-- 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
SELECT id, product_id, quantity 
FROM invoice_out_items 
WHERE invoice_out_id = @invoice_id
AND available_for_return > 0;

-- 2. Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø±Ø¬Ø§Ø¹ ÙƒØ§Ù…Ù„
INSERT INTO returns 
(invoice_id, customer_id, total_amount, return_type, status)
VALUES 
(@invoice_id, @customer_id, @invoice_total, 'full', 'completed');

-- 3. Ù„ÙƒÙ„ Ø¨Ù†Ø¯ ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
FOR EACH item IN items:
    -- Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
    SET @return_qty = item.available_for_return;
    
    -- ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    UPDATE invoice_out_items 
    SET returned_quantity = quantity 
    WHERE id = item.id;
    
    -- Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    CALL RestockItem(item.id, @return_qty, @return_id);
END FOR;

-- 4. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
UPDATE invoices_out 
SET 
    delivered = 'reverted',
    total_cost = 0,
    profit_amount = 0,
    updated_at = NOW()
WHERE id = @invoice_id;

-- 5. Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
CALL ProcessFinancialReturn(@invoice_id, @return_id, 'full');
```

## ğŸ”„ **Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ© (consumed)**

### **Ù…Ø´ÙƒÙ„Ø©:** Ø¯ÙØ¹Ø© `remaining = 0` Ùˆ `status = 'consumed'`

### **Ø§Ù„Ø­Ù„:** 
```sql
-- Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ØŒ Ù†ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹Ø©
SELECT remaining, status FROM batches WHERE id = @batch_id;

IF @current_status = 'consumed' AND @return_qty > 0 THEN
    -- Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©
    UPDATE batches 
    SET 
        remaining = @return_qty,
        status = 'active',
        revert_reason = CONCAT('Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¥Ø±Ø¬Ø§Ø¹ ÙØ§ØªÙˆØ±Ø© #', @invoice_id),
        updated_at = NOW()
    WHERE id = @batch_id;
ELSE
    -- Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
    UPDATE batches 
    SET remaining = remaining + @return_qty 
    WHERE id = @batch_id;
END IF;
```

## ğŸ’° **Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ù„Ù„Ø¯ÙØ¹ ÙˆØªØ£Ø«ÙŠØ±Ù‡Ø§**

### **Ø§Ù„Ù†ÙˆØ¹ 1: ÙØ§ØªÙˆØ±Ø© Ù…Ø¤Ø¬Ù„Ø© (Ù„Ù… ØªØ¯ÙØ¹)**
```sql
-- ÙÙ‚Ø· ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯
UPDATE customers 
SET balance = balance - @return_amount 
WHERE id = @customer_id;

-- Ø­Ø±ÙƒØ© Ø§Ù„Ø¹Ù…ÙŠÙ„
INSERT INTO customer_transactions 
(customer_id, transaction_type, amount, description,
 balance_before, balance_after, invoice_id, return_id)
VALUES 
(@customer_id, 'return', -@return_amount,
 'Ø¥Ø±Ø¬Ø§Ø¹ ÙØ§ØªÙˆØ±Ø© Ù…Ø¤Ø¬Ù„Ø©',
 @old_balance, @old_balance - @return_amount,
 @invoice_id, @return_id);
```

### **Ø§Ù„Ù†ÙˆØ¹ 2: ÙØ§ØªÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø© ÙƒÙ„ÙŠØ§Ù‹**
```sql
-- Ø®ÙŠØ§Ø± 1: Ù†Ù‚Ø¯ÙŠ
INSERT INTO invoice_payments 
(invoice_id, payment_amount, payment_method, notes)
VALUES 
(@invoice_id, -@return_amount, 'cash', 'Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¥Ø±Ø¬Ø§Ø¹');

-- Ø®ÙŠØ§Ø± 2: Ù…Ø­ÙØ¸Ø©
UPDATE customers 
SET wallet = wallet + @return_amount 
WHERE id = @customer_id;

INSERT INTO wallet_transactions (...) VALUES (...);
```

### **Ø§Ù„Ù†ÙˆØ¹ 3: ÙØ§ØªÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹**
```sql
-- Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡
SET @paid = (SELECT paid_amount FROM invoices_out WHERE id = @invoice_id);
SET @return = @return_amount;

IF @return <= @paid THEN
    -- ÙƒÙ„ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹
    CALL ProcessRefund(@customer_id, @return, 'Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹');
ELSE
    -- Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹ + Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¯ÙŠÙ†
    SET @refund_part = @paid;
    SET @credit_part = @return - @paid;
    
    -- Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¯ÙÙˆØ¹
    CALL ProcessRefund(@customer_id, @refund_part, 'Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù…Ø¯ÙÙˆØ¹');
    
    -- ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†
    UPDATE customers 
    SET balance = balance - @credit_part 
    WHERE id = @customer_id;
    
    -- ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    UPDATE invoices_out 
    SET 
        paid_amount = paid_amount - @refund_part,
        remaining_amount = remaining_amount - @credit_part
    WHERE id = @invoice_id;
END IF;
```

## ğŸ“‹ **Ù†Ù…ÙˆØ°Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„ Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹**

```sql
-- Ø­Ø§Ù„Ø©: Ø¥Ø±Ø¬Ø§Ø¹ 5 Ù…Ù† 10 ÙˆØ­Ø¯Ø§Øª (Ø¨Ù†Ø¯ Ø¹Ø§Ø¯ÙŠØŒ ÙØ§ØªÙˆØ±Ø© Ù…Ø¤Ø¬Ù„Ø©)
-- ÙÙŠ returns
{
  id: 1001,
  invoice_id: 5001,
  customer_id: 301,
  total_amount: 100.00,  -- 5 ÙˆØ­Ø¯Ø§Øª Ã— 20
  return_type: 'partial',
  status: 'completed'
}

-- ÙÙŠ return_items
{
  id: 2001,
  return_id: 1001,
  invoice_item_id: 7001,
  product_id: 101,
  quantity: 5.00,
  return_price: 20.00,
  total_amount: 100.00,
  batch_allocations: '[
    {"batch_id": 1, "qty": 3, "unit_cost": 15.00},
    {"batch_id": 2, "qty": 2, "unit_cost": 16.00}
  ]',
  status: 'restocked'
}

-- ÙÙŠ batches (ØªØ­Ø¯ÙŠØ«)
-- Ø§Ù„Ø¯ÙØ¹Ø© 1: remaining ØªØ²ÙŠØ¯ Ù…Ù† 0 Ø¥Ù„Ù‰ 3 (ÙˆØªØµØ¨Ø­ active)
-- Ø§Ù„Ø¯ÙØ¹Ø© 2: remaining ØªØ²ÙŠØ¯ Ù…Ù† 2 Ø¥Ù„Ù‰ 4

-- ÙÙŠ invoice_out_items
-- returned_quantity: ØªØ²ÙŠØ¯ Ù…Ù† 0 Ø¥Ù„Ù‰ 5
-- return_flag: ØªØ¨Ù‚Ù‰ 0 (Ù„Ø£Ù† 5 < 10)
-- available_for_return: ØªØµØ¨Ø­ 5 ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

-- ÙÙŠ invoices_out
-- total_cost: ÙŠÙ‚Ù„ Ø¨Ù€ 77.50 (5 ÙˆØ­Ø¯Ø§Øª Ã— Ù…ØªÙˆØ³Ø· ØªÙƒÙ„ÙØ© 15.5)
-- profit_amount: ÙŠÙ‚Ù„ Ø¨Ù€ 100 ÙˆÙŠØ²ÙŠØ¯ Ø¨Ù€ 77.50 = ØµØ§ÙÙŠ -22.50

-- ÙÙŠ customers
-- balance: ÙŠÙ‚Ù„ Ø¨Ù€ 100.00

-- ÙÙŠ customer_transactions
{
  transaction_type: 'return',
  amount: -100.00,
  description: 'Ø¥Ø±Ø¬Ø§Ø¹ Ø¬Ø²Ø¦ÙŠ ÙØ§ØªÙˆØ±Ø© #5001',
  balance_before: 500.00,
  balance_after: 400.00
}
```

## ğŸ¯ **Ø§Ù„Ø®Ù„Ø§ØµØ© ÙˆØ§Ù„ØªÙˆØµÙŠØ§Øª**

### **Ø§Ù„ØªÙˆØµÙŠØ§Øª:**

1. **Ù„Ø§ ØªØ­Ø°Ù Ø£ÙŠ Ø³Ø¬Ù„Ø§Øª** - Ø£Ø±Ø´ÙŠÙ ÙƒÙ„ Ø´ÙŠØ¡
2. **Ø§Ø³ØªØ®Ø¯Ù… JSON ÙÙŠ `batch_allocations`** Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª
3. **Ø£Ù†Ø´Ø¦ ØªØ®ØµÙŠØµØ§Øª Ø¹ÙƒØ³ÙŠØ©** ÙÙŠ `sale_item_allocations`
4. **Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ `return_flag` Ùˆ `available_for_return`** Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠÙŠÙ†
5. **Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©** Ø¨ØªØºÙŠÙŠØ± `status` Ø¥Ù„Ù‰ `active`

### **Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:**

1. **Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:** ÙŠØ¹ÙˆØ¯ Ù„Ù†ÙØ³ Ø§Ù„Ø¯ÙØ¹Ø§Øª (FIFO Ø¹ÙƒØ³ÙŠ)
2. **Ø§Ù„ØªÙƒÙ„ÙØ©:** ØªØ®ØµÙ… Ù…Ù† `total_cost` Ø§Ù„ÙØ§ØªÙˆØ±Ø©
3. **Ø§Ù„Ø±Ø¨Ø­:** ÙŠØ¹Ø§Ø¯ Ø­Ø³Ø§Ø¨Ù‡ Ø¯Ø§Ø¦Ù…Ø§Ù‹
4. **Ø§Ù„Ø®ØµÙ…:** Ù†Ø±Ø¬Ø¹ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…
5. **Ø§Ù„Ø¯ÙØ¹:** Ù†ØªØ¨Ø¹ Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©

Ù‡Ù„ ØªØ±ÙŠØ¯Ù†ÙŠ Ø£Ù† Ø£Ø´Ø±Ø­ Ø£ÙŠ Ø¬Ø²Ø¡ Ø¨Ø´ÙƒÙ„ Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹ Ø£Ùˆ Ø£Ù‚Ø¯Ù… Ø£Ù…Ø«Ù„Ø© ÙƒÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠØ©ØŸ