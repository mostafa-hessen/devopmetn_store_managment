ركز معايا كويس جدا جدا جدا
1- عندي صفحه تقارير المبيعات اريد التعديل عليها حتي تضمن الاتي

** اضافه فلاتر مؤجله مسملمه جزئيه + فلاتر العميل امكانيه البحث + امكانيه البحث بالملاحظه 
عاوز فلاتر ذكيه جدا سلسه في التعامل

** فلتر من اول المده يعرض الفواتير من سنه2020 حتي الان
** الفواتير الان اصبح عليها خصومات يجب تضمين ذلك + تضمين الخومات اللي علي البند
** عدم عرض اي فاتوره
deliverd --> canceld or reverted
** الان اصبح هناك نظام مرتجعات لو في بند مرتجع كامل متعرضش
+
لو في جزء مرتجع بمعني
returned_quantity >0 && < quantity
يجب عرض في هذا البند 
عرض الكميه المرتجعه الحاليه الاصليه
قيمه البند بعد المرتجع
unit_price_after_discount * (remaining = quantity - returned_quantity)
اجمالي سعر البند بناء علي 



CREATE TABLE `invoices_out` (
  `id` int(11) NOT NULL COMMENT 'المعرف التلقائي للفاتورة',
  `customer_id` int(11) NOT NULL COMMENT 'معرف العميل المرتبط بالفاتورة',
  `delivered` enum('yes','no','canceled','reverted','partial') NOT NULL DEFAULT 'no',
  `invoice_group` enum('group1','group2','group3','group4','group5','group6','group7','group8','group9','group10','group11') NOT NULL COMMENT 'مجموعة الفاتورة (من 1 إلى 11)',
  `created_by` int(11) DEFAULT NULL COMMENT 'معرف المستخدم الذي أنشأ الفاتورة',
  `created_at` timestamp NOT NULL DEFAULT current_timestamp() COMMENT 'تاريخ ووقت الإنشاء',
  `updated_by` int(11) DEFAULT NULL COMMENT 'معرف المستخدم الذي آخر من عدل الفاتورة',
  `updated_at` timestamp NULL DEFAULT NULL ON UPDATE current_timestamp() COMMENT 'تاريخ ووقت آخر تعديل',
  `notes` text DEFAULT NULL,
  `cancel_reason` varchar(255) DEFAULT NULL,
  `revert_reason` varchar(255) DEFAULT NULL,
  `total_before_discount` decimal(12,2) DEFAULT 0.00 COMMENT 'مجموع البيع قبل أي خصم',
  `discount_type` enum('percent','amount') DEFAULT 'percent' COMMENT 'نوع الخصم',
  `discount_value` decimal(10,2) DEFAULT 0.00 COMMENT 'قيمة الخصم: إذا percent -> تخزن النسبة (مثال: 10) وإلا قيمة المبلغ',
  `discount_amount` decimal(12,2) DEFAULT 0.00 COMMENT 'مبلغ الخصم المحسوب بالعملة',
  `total_after_discount` decimal(12,2) DEFAULT 0.00 COMMENT 'المجموع النهائي بعد الخصم',
  `total_cost` decimal(12,2) DEFAULT 0.00 COMMENT 'اجمالي التكلفة (مخزن للتقارير)',
  `profit_amount` decimal(12,2) DEFAULT 0.00 COMMENT 'اجمالي الربح = total_before_discount - total_cost',
  `paid_amount` decimal(12,2) DEFAULT 0.00,
  `remaining_amount` decimal(12,2) DEFAULT 0.00,
  `work_order_id` int(11) DEFAULT NULL,
  `discount_scope` enum('invoice','items','mixed') DEFAULT 'invoice' COMMENT 'مكان تطبيق الخصم'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='جدول فواتير العملاء الصادرة';

CREATE TABLE `invoice_out_items` (
  `id` int(11) NOT NULL COMMENT 'المعرف التلقائي لبند الفاتورة',
  `invoice_out_id` int(11) NOT NULL COMMENT 'معرف الفاتورة الصادرة (مفتاح أجنبي لجدول invoices_out)',
  `product_id` int(11) NOT NULL COMMENT 'معرف المنتج (مفتاح أجنبي لجدول products)',
  `quantity` decimal(10,2) NOT NULL COMMENT 'الكمية المباعة من المنتج',
  `total_before_discount` decimal(10,2) NOT NULL COMMENT 'السعر الإجمالي للبند قبل الخصم (الكمية * سعر الوحدة)',
  `cost_price_per_unit` decimal(10,2) NOT NULL DEFAULT 0.00,
  `created_at` timestamp NOT NULL DEFAULT current_timestamp() COMMENT 'تاريخ إضافة البند',
  `updated_at` timestamp NULL DEFAULT NULL ON UPDATE current_timestamp() COMMENT 'تاريخ آخر تعديل للبند',
  `selling_price` decimal(10,2) NOT NULL,
  `price_type` enum('retail','wholesale') NOT NULL DEFAULT 'wholesale',
  `returned_quantity` decimal(10,2) NOT NULL DEFAULT 0.00 COMMENT 'الكمية المرتجعة',
  `return_flag` tinyint(1) GENERATED ALWAYS AS (case when `returned_quantity` = `quantity` then 1 else 0 end) STORED COMMENT '1 إذا تم إرجاع البند بالكامل (تمام)، 0 جزئي',
  `available_for_return` decimal(10,2) GENERATED ALWAYS AS (`quantity` - `returned_quantity`) STORED COMMENT 'الكمية المتاحة للمرتجع',
  `discount_type` enum('percent','amount') DEFAULT NULL,
  `discount_value` decimal(10,2) DEFAULT 0.00,
  `discount_amount` decimal(12,2) DEFAULT 0.00,
  `total_after_discount` decimal(12,2) DEFAULT 0.00
  `unit_price_after_discount` decimal(10,2) DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

--


3- عرض كل فاتوره عليها بادج مؤجله ام مدفوع ام جزئي
بناء علي هذا
 CASE 
            WHEN i.delivered = 'reverted' THEN 'returned'
            WHEN i.remaining_amount = 0 THEN 'paid'
            WHEN i.paid_amount > 0 AND i.remaining_amount > 0 THEN 'partial'
            ELSE 'pending'
        END AS status,
      AND i.delivered != 'canceled'



4- لو فاتوره تبع شغلانه 
تعرض اسم ورقم الشغلانه تحت رقم الفاتوره

CREATE TABLE `work_orders` (
  `id` int(11) NOT NULL,
  `customer_id` int(11) NOT NULL,
  `title` varchar(255) NOT NULL COMMENT 'عنوان الشغلانة',
  `description` text DEFAULT NULL COMMENT 'وصف تفصيلي',
  `status` enum('pending','in_progress','completed','cancelled') DEFAULT 'pending',
  `start_date` date NOT NULL COMMENT 'تاريخ البدء',
  `notes` text DEFAULT NULL COMMENT 'ملاحظات إضافية',
  `total_invoice_amount` decimal(12,2) DEFAULT 0.00 COMMENT 'إجمالي فواتير الشغلانة',
  `total_paid` decimal(12,2) DEFAULT 0.00 COMMENT 'إجمالي المدفوع',
  `total_remaining` decimal(12,2) DEFAULT 0.00 COMMENT 'إجمالي المتبقي',
  `created_by` int(11) NOT NULL,
  `created_at` timestamp NOT NULL DEFAULT current_timestamp(),
  `updated_at` timestamp NULL DEFAULT NULL ON UPDATE current_timestamp()
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;



لو فاتوره فيها مرتجع 
يمكن عرض المرتجع في مودال من خلال
CREATE TABLE `returns` (
  `id` int(11) PRIMARY KEY AUTO_INCREMENT,
  `invoice_id` int(11) NOT NULL,
  `customer_id` int(11) NOT NULL,
  `return_date` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `total_amount` DECIMAL(12,2) NOT NULL DEFAULT 0.00,
  `return_type` ENUM('full','partial','exchange') DEFAULT 'partial',
  `status` ENUM('pending','approved','completed','rejected') DEFAULT 'pending',
  `reason` TEXT,
  `approved_by` int(11) NULL,
  `approved_at` DATETIME NULL,
  `created_by` int(11) NOT NULL,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `notes` TEXT
);

CREATE TABLE `return_items` (
  `id` int(11) PRIMARY KEY AUTO_INCREMENT,
  `return_id` int(11) NOT NULL,
  `invoice_item_id` int(11) NOT NULL,
  `product_id` int(11) NOT NULL,
  `quantity` DECIMAL(10,2) NOT NULL,
  `return_price` DECIMAL(10,2) NOT NULL, -- السعر وقت الإرجاع
  `total_amount` DECIMAL(10,2) NOT NULL,
  `batch_allocations` JSON, -- لتتبع أي دفعات تم إرجاعها
  `status` ENUM('pending','restocked','discarded') DEFAULT 'pending',
  `restocked_qty` DECIMAL(10,2) DEFAULT 0.00,
  `restocked_at` DATETIME NULL,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP
);

يغضل عرض البنود محمع + مغ رقم الفاتوره المرتجعه