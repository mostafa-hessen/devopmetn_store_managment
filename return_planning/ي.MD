Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ø§ÙÙ‚Ø±Ø£ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°)

Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (batches, sale_item_allocations, invoices_out, invoice_out_items, returns, return_items, customers, customer_transactions, invoice_payments, wallet_transactions):

ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø±Ø¬Ø§Ø¹ ÙŠØ¬Ø¨ Ø£Ù† ØªØªÙ… Ø¯Ø§Ø®Ù„ transaction ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (BEGIN; ...; COMMIT) Ù…Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙÙ„ ØµÙÙˆÙ (SELECT ... FOR UPDATE) Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…ØªØ£Ø«Ø±Ø© Ù„ØªØ¬Ù†Ù‘Ø¨ Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªÙ†Ø§ÙØ³.

Ø³Ø¬Ù‘Ù„ ÙƒÙ„ Ø®Ø·ÙˆØ© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ù€ CUSTOMER_TRANSACTION
Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: ÙÙ‚Ø· Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… ØµÙ„Ø§Ø­ÙŠØ© returns:create ÙŠÙ…ÙƒÙ†Ù‡Ù… ØªÙ†ÙÙŠØ° API.

ØªØ¹Ø§Ù…Ù„ Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù…Ø¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª (batches) Ø·Ø¨Ù‚Ø§Ù‹ Ù„Ù…Ø¨Ø¯Ø£ FIFO Ø§Ù„Ø¹ÙƒØ³ÙŠ (Ø¥Ø±Ø¬Ø§Ø¹ Ù„ÙƒÙ„ Ø¯ÙØ¹Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ®ØµÙŠØµ Ø§Ù„Ø£ØµÙ„ÙŠ).


âœ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ù€ API (Endpoints Ø£Ø³Ø§Ø³ÙŠØ©)
1) POST /api/returns

Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø±Ø¬Ø§Ø¹ (partial / full ).

Request (JSON)

{
  "invoice_id": 5001,
  "customer_id": 301,
  "return_type": "partial", // partial | full | exchange
  "items": [
    {
      "invoice_item_id": 7001,
      "product_id": 101,
      "quantity": 5,
      "reason": "Damaged",
      "refund_preference": "wallet" // cash | wallet | Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
    }
  ],
  "notes": "note ...",
}


=
âš™ï¸ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Pseudo-code / Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„)

Ø¹Ù†Ø¯ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨:


Ø§Ø¨Ø¯Ø£ TRANSACTION.

Ø§Ù‚ÙÙ„ Ø³Ø·Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ùˆ Ø³Ø·Ø± Ø§Ù„Ø¨Ù†ÙˆØ¯ Ùˆ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ùˆ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø°Ø§Øª Ø§Ù„ØµÙ„Ø©:
SELECT * FROM invoices_out WHERE id=? FOR UPDATE;
SELECT * FROM invoice_out_items WHERE invoice_out_id=? FOR UPDATE;

ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† available_for_return ÙƒØ§ÙÙ Ù„ÙƒÙ„ invoice_item_id. Ø¥Ù† ØªØ¬Ø§ÙˆØ² â†’ rollback Ùˆ 400 error.

Ø¥Ø°Ø§ return_type = full â€” Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø±Ø¬Ø§Ø¹ (available_for_return > 0) ÙˆØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§.

Ù„ÙƒÙ„ Ø¨Ù†Ø¯:

Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ sale_item_allocations Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ø§Ù„Ø£ØµÙ„ÙŠØ©) ÙˆØ§Ø­ØªØ³Ø¨ ØªÙƒÙ„ÙØ© ÙƒÙ„ ÙˆØ­Ø¯Ø© (unit_cost) Ùˆ line_cost.
ÙˆØ§Ø®ØµÙ… Ù…Ù†Ù‡Ø§ Ø¨Ù†Ø§Ø¡ Ø¹Ù„ÙŠ Ø§Ù„Ø§Ø­Ø¯Ø« Ø¹ÙƒØ³ fIFO
Ù„Ùˆ Ù…Ø«Ù„Ø§ 5 Ø±Ø¬Ø¹Øª 2 Ø¨Ø®ØµÙ… 

Ù„Ùˆ batches.status = 'consumed' Ùˆ @return_qty > 0 -> UPDATE batches SET remaining = remaining + @return_qty, status='active', revert_reason=..., updated_at=NOW()

ÙˆØ¥Ù„Ø§ -> UPDATE batches SET remaining = remaining + @return_qty

Ø¥Ù†Ø´Ø§Ø¡ ØªØ®ØµÙŠØµ Ø¹ÙƒØ³ÙŠ ÙÙŠ sale_item_allocations:

INSERT INTO sale_item_allocations
(sale_item_id, batch_id, qty, unit_cost, line_cost, created_by, return_id, is_return)
VALUES (@sale_item_id, @batch_id, -@return_qty, @unit_cost, -(@unit_cost*@return_qty), @user_id, @return_id, TRUE);


ØªØ­Ø¯ÙŠØ« invoice_out_items:
UPDATE invoice_out_items SET returned_quantity = returned_quantity + @return_qty WHERE id = @invoice_item_id;
Ù„Ùˆ Ø§Ù„ÙƒÙ…ÙŠÙ‡ Ø§Ù„Ù„ÙŠ Ù…Ø±Ø¬Ø¹Ù‡ ØªØ³Ø§ÙˆÙŠ Ø§Ù„ÙƒÙ…ÙŠÙ‡ Ø§Ù„Ù…ØªØ§Ø­ Ù„Ù„Ø§Ø±Ø¬Ø§Ø¹ 
available_for_return
Ø§Ø°Ø§ Ø­Ø¯Ø« Ø­Ù‚Ù„
  `return_flag` tinyint(1) GENERATED ALWAYS AS (case when `returned_quantity` = `quantity` then 1 else 0 end) STORED COMMENT '1 Ø¥Ø°Ø§ ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¨Ù†Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (ØªÙ…Ø§Ù…)ØŒ 0 Ø¬Ø²Ø¦ÙŠ',

Ø­Ø¯Ø« Ø­Ù‚Ù„ 
cost_price_per_unit --> 
Ù…Ø«Ø§Ù„ Ù„Ùˆ Ø³Ø§Ø­Ø¨ Ù…Ù†ØªØ¬ Ù…Ù† Ø¯ÙØ¹ØªÙŠÙ† 
Ù…Ø«Ù„Ø§ 2 Ø¯ÙØ¹Ù‡ 1 Ø¨Ø³Ø¹Ø± 10 Ø¬Ù†ÙŠÙ‡ 
Ø«Ù… 3 Ù‚Ø·Ø¹ Ù…Ù† Ø¯ÙØ¹Ù‡ 2 Ø¨Ø³Ø¹Ø± 20 Ø¬Ù†ÙŠÙ‡

Ø¨ÙŠØªÙ… Ø­Ø³Ø§Ø¨ 
cost_price_per_unit -->  ÙƒÙ…ØªÙˆØ³Ø·

Ø§Ø°Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø±Ø¬Ø§Ø¹ Ù…Ø«Ù„Ø§ Ø±Ø¬Ø¹Øª 3 Ø§Ø°Ø§ Ø§Ù„Ø³Ø¹Ø± Ø¨Ù‚ÙŠ 10  Ø§Ùˆ Ù„Ùˆ Ø±Ø¬Ø¹Øª ØªÙ†Ù†ÙŠÙ† ÙŠØ­Ø³Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø·
Ø§Ù„Ù…ØªÙˆØ³Ø· = (Î£ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡) Ã· Î£ Ø§Ù„ÙƒÙ…ÙŠØ§Øª = (270.00) Ã· 5.00 = 54.00



ØªØ­Ø¯ÙŠØ« invoices_out:

Ø§Ø­Ø³Ø¨ $return_cost = Ù…Ø¬Ù…ÙˆØ¹ (sale_item_allocation.unit_cost * returned_qty) Ø­Ø³Ø¨ sale_item_allocations.

UPDATE invoices_out SET total_cost = total_cost - return_cost,  profit_amount = total_after_discount - total_cost

Ø­Ø¯Ù‘Ø« delivered Ø¥Ù„Ù‰ Ùˆ 'reverted' Ø¥Ø°Ø§ Ø§Ù„ÙƒÙ„ Ø±Ø¬Ø¹.

Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©:

Ø¬Ù„Ø¨ paid_amount Ù…Ù† invoices_out.

Ø¥Ø°Ø§ paid_amount === 0 (ÙØ§ØªÙˆØ±Ø© Ù…Ø¤Ø¬Ù„Ø©): UPDATE customers SET balance = balance - return_amount + UPDATE invoices_out SET remaining_amount-=return_amount

Ø¥Ø°Ø§ paid_amount > 0 (Ù…Ø¯ÙÙˆØ¹Ø© ÙƒÙ„ÙŠØ§Ù‹ and remaining_amount =0 


refund_from_amount = Ù‚ÙŠÙ…Ù‡ Ø§Ù„Ù…Ø±ØªØ¬Ø¹
Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø³ØªØ±Ø¯ ÙŠØ¹Ø§Ù„Ø¬ Ø­Ø³Ø¨ payment_option:

cash: Ø§Ø¯Ø®Ù„ Ø³Ø¬Ù„ Ø³Ø§Ù„Ø¨ ÙÙŠ invoice_payments (payment_amount = -refund_amount) Ù…Ø¹ notes='Refund for return'.


wallet: UPDATE customers SET wallet = wallet + refund_from_amountÙˆ INSERT INTO wallet_transactions(...).




Ù„ÙˆØ¬Ø²Ø¦ÙŠ ÙŠØ¹Ù†ÙŠ
paid_amount > 0&& remaining_amount >0 
ÙŠØ®ØµÙ… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ù‡ ÙˆÙ„Ùˆ ÙÙŠ ÙÙ„ÙˆØ³ Ø¨Ø±Ø¬Ø¹Ø§Ù‡ 
cash: Ø§Ø¯Ø®Ù„ Ø³Ø¬Ù„ Ø³Ø§Ù„Ø¨ ÙÙŠ invoice_payments (payment_amount = -refund_amount) Ù…Ø¹ notes='Refund for return'.


wallet: UPDATE customers SET wallet = wallet + refund_from_amountÙˆ INSERT INTO wallet_transactions(...).


ÙˆØ§Ø°Ø§ Ø®ØµÙ… Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ù‡ ÙŠØ­Ø¯Ø« Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ 

customers.balance.

Ù…Ø«Ø§Ù„ 
ÙØ§ØªÙˆØ±Ù‡ Ø¨ 200 Ø¬Ù†ÙŠÙ‡ 
Ø¯ÙØ¹Ù‡ 50 
Ø§Ø°Ù† Ø¹Ù„ÙŠÙ‡ 150 
Ø¬Ù‡ Ø±Ø¬Ø¹ Ø¨ 50 
Ø§Ø°Ø§ Ø§Ø­Ø¯Ø« Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ù‡ ÙˆØ§Ø­Ø³Ø¨ Ø§Ù† Ø¹Ù„ÙŠÙ‡ 
100 


Ø·ÙŠØ¨ Ù„Ùˆ Ù†ÙØ³ Ø§Ù„ÙØ§ØªÙˆØ±Ù‡200 
Ø¯ÙØ¹ 100
ÙˆØ¹Ù„ÙŠÙ‡ 
100
ÙˆØ¬Ù‡ Ø±Ø¬Ø¹
Ø§Ø°Ø§ Ø§Ø®ØµÙ… Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ù‡ ÙˆØ§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ø±Ø¯ Ù„ÙŠÙ‡ 100 ÙˆØ§Ø­ÙˆÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ù‡ Ù„Ù…Ø±ØªØ¬Ø¹

Ø¯Ø§Ø¦Ù…Ø§ ÙŠØ³Ø¬Ù„ Ù…Ø§Ø³Ø¨Ù‚ Ø¨Ø¯Ù‚Ù‡

Ø¯Ø§Ø¦Ù…Ù‹Ø§ INSERT INTO customer_transactions Ù…Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯Ø©. + Ø³Ø¬Ù„ Ø¨ÙˆØµÙ Ø¯Ù‚ÙŠÙ‚

Ø£Ø¶Ù Ø³Ø¬Ù„Ø§Øª ØªØ¯Ù‚ÙŠÙ‚ () Ù„ÙƒÙ„ ØªØ¹Ø¯ÙŠÙ„ (Ù…Ù†ÙÙ‘Ø°ØŒ ÙˆÙ‚ØªØŒ reason).

COMMIT TRANSACTION.

Return JSON success.





ğŸ”’ Ù‚ÙˆØ§Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ù€ Discounts Ùˆ Cost Allocation

Ø®ØµÙ… Ø¨Ù†Ø³Ø¨Ø© (%): unit_price_after_discount = selling_price * (1 - discount_percent/100). Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø¬Ø²Ø¡ Ù…Ù† Ø¨Ù†Ø¯ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ø§Ø­ØªØ³Ø§Ø¨ return_price.

Ø®ØµÙ… Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª (amount): ÙˆØ²Ù‘Ø¹ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø«Ø§Ø¨Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù†Ø³Ø¨ÙŠØ§Ù‹ Ø­Ø³Ø¨ total_before_discount Ù„ÙƒÙ„ Ø¨Ù†Ø¯. Ø¹Ù†Ø¯ Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù†Ø¯ØŒ ØªÙØ®ØµÙ… Ù†Ø³Ø¨Ø© Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø«Ø§Ø¨Øª ÙˆØªÙØ³ØªØ®Ø¯Ù… Ù„Ø­Ø³Ø§Ø¨ unit_price_after_discount.

Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ: Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ cost_price_per_unit Ø§Ù„Ø¸Ø§Ù‡Ø± ÙÙŠ invoice ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ø´ØªÙ‚Ø© Ù…Ù† Ø¹Ø¯Ø© Ø¯ÙØ¹Ø§Øª â€” Ø§Ø³ØªØ®Ø¯Ù… sale_item_allocations Ù„Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©.

âœ… Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙØµÙ„Ø© (Scenarios) â€” ÙƒÙ„ Ø­Ø§Ù„Ø© Ø¨Ø®Ø·ÙˆØ§Øª Ù…ØªÙˆÙ‚Ø¹Ø© ÙˆØªØºÙŠÙŠØ±Ø§Øª DB
Ø­Ø§Ù„Ø© A â€” Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù†Ø¯ Ø¹Ø§Ø¯ÙŠ (Partial, no discount)

Ù…Ø¯Ø®Ù„Ø§Øª: invoice_item_id=7001, quantity=5, invoice had 10.

Ø§Ù„ØªØ­Ù‚Ù‚: available_for_return = 10 - returned_quantity >= 5.

ØªØºÙŠÙŠØ±Ø§Øª:

batches.remaining Ù„ÙƒÙ„ batch + qty ÙˆÙÙ‚ allocations.

sale_item_allocations â† Ø¥Ø¯Ø±Ø§Ø¬ ØªØ®ØµÙŠØµ Ø¹ÙƒØ³ÙŠ Ø¨ÙƒÙ…ÙŠØ© -5 ÙÙŠ Ù†ÙØ³ batch_ids.

invoice_out_items.returned_quantity += 5.

returns Ùˆ return_items Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯.

invoices_out.total_cost -= (5 * avg_unit_cost) ; profit_amount ÙŠØ¹Ø§Ø¯ Ø­Ø³Ø§Ø¨Ù‡.

Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙØ¹: customers.balance ÙŠÙ‚Ù„ Ø£Ùˆ invoice_payments/wallet_transactions ØªÙÙ†Ø´Ø£.

Ø§Ø®ØªØ¨Ø§Ø±: Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°ØŒ available_for_return ÙŠÙ‚Ù„ Ø¨Ù‚ÙŠÙ…Ø© 5ØŒ batches.remaining Ø²Ø§Ø¯Øª.

Ø­Ø§Ù„Ø© B â€” Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù†Ø¯ Ø¹Ù„ÙŠÙ‡ Ø®ØµÙ… (%)

Ø¨Ù†Ø¯: 10 units, price 20, discount 10% (net unit price 18). Return 3 units.

ØªØºÙŠÙŠØ±Ø§Øª:

Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¥Ù„Ù‰ batches ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø© A.

return_price Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø© = 18. total_amount = 54.

invoices_out.total_after_discount ÙŠÙ‚Ù„ Ø¨Ù…Ù‚Ø¯Ø§Ø± 54.

total_cost ÙŠÙ‚Ù„ Ø¨Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ¹Ù„ÙŠØ©.

Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙƒØ§Ù„Ø³Ø§Ø¨Ù‚ ÙˆÙ„ÙƒÙ† Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ Ù…Ø¨Ù„Øº 54.

Ø§Ø®ØªØ¨Ø§Ø±: ØªØ­Ù‚Ù‚ Ø£Ù† return_items.return_price = 18ØŒ ÙˆØ£Ù† invoices_out.discount_amount Ù†Ù‚ØµØª Ù†Ø³Ø¨ÙŠØ§Ù‹.

Ø­Ø§Ù„Ø© C â€” Ø¥Ø±Ø¬Ø§Ø¹ ÙØ§ØªÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø© (Full return)

Ø§Ù„ØªØ­Ù‚Ù‚: Ù„ÙƒÙ„ Ø¨Ù†Ø¯ØŒ available_for_return = quantity.

ØªØºÙŠÙŠØ±Ø§Øª:

Ù„ÙƒÙ„ Ø¨Ù†Ø¯: returned_quantity = quantity.

Ù„ÙƒÙ„ ØªØ®ØµÙŠØµ: Ø¥Ù†Ø´Ø§Ø¡ ØªØ®ØµÙŠØµØ§Øª Ø¹ÙƒØ³ÙŠØ© ØªØºØ·ÙŠ ÙƒØ§ÙØ© Ø§Ù„ÙƒÙ…ÙŠØ§Øª.

batches.remaining ØªÙØ¹Ø§Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØªÙÙØ¹Ù„ Ø£ÙŠ Ø¯ÙØ¹Ø§Øª consumed.

invoices_out.delivered = 'reverted', total_cost = 0, profit_amount = 0.

Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©: Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ÙƒØ§Ù…Ù„ Ø­Ø³Ø¨ paid_amount (Ù†Ù‚Ø¯/Ù…Ø­ÙØ¸Ø©/ØªØ®ÙÙŠØ¶ Ø§Ù„Ø¯ÙŠÙ†).

Ø§Ø®ØªØ¨Ø§Ø±: Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØªØµØ¨Ø­ revertedØŒ Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØªØºÙŠØ± ÙƒÙ…Ø§ Ù‡Ùˆ Ù…ØªÙˆÙ‚Ø¹.

Ø­Ø§Ù„Ø© D â€” ÙØ§ØªÙˆØ±Ø© Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹ + Ø¥Ø±Ø¬Ø§Ø¹ ÙŠØ²ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙÙˆØ¹

Ù…Ø«Ø§Ù„: invoice total=200, paid_amount=100, return_amount=150.

Ù…Ù†Ø·Ù‚:

refund_from_paid = 100 â†’ Ø±Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (cash/wallet).

credit_part = 50 â†’ ÙŠÙ‚Ù„Ù„ customers.balance Ø¨Ù…Ù‚Ø¯Ø§Ø± 50.

invoices_out.paid_amount -= 100; remaining_amount -= 50.

Ø§Ø®ØªØ¨Ø§Ø±: post-state: paid_amount=0, balance reduced by 50.

Ø­Ø§Ù„Ø© E â€” Ø¥Ø±Ø¬Ø§Ø¹ Ø¯ÙØ¹Ø© ÙƒØ§Ù†Øª consumed

ØªØ®ØµÙŠØµ Ù„Ø¯ÙØ¹Ø© Ù…Ø¹ remaining=0 Ùˆ status='consumed', return_qty>0.

Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª:

batches.status => 'active'

batches.remaining = return_qty (Ø£Ùˆ += return_qty Ø¥Ù† Ø£Ø±Ø¯Øª Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ±Ø§ÙƒØ¨)

Ø§Ø®ØªØ¨Ø§Ø±: batches.status Ø§Ù„Ø¢Ù† 'active' Ùˆ remaining > 0.

Ø­Ø§Ù„Ø© F â€” Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ø±Ø¬Ø§Ø¹ Ù…ØªÙƒØ±Ø± (Idempotency)

Ù†ÙØ³ external_return_ref ÙŠÙØ±Ø³ÙÙ„ Ù…Ø±ØªÙŠÙ†.

Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ù„Ø§ ØªÙÙ†ÙØ° ØªØºÙŠÙŠØ±Ø§Øª Ù…ÙƒØ±Ø±Ø©Ø› Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØªØ¹ÙŠØ¯ Ø§Ù„Ù€ return_id Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø¹ Ø­Ø§Ù„Ø© success=true Ùˆ code 200.

Ø­Ø§Ù„Ø© G â€” Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø®ØµÙ… Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ¹

Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©: Ø§Ù„Ø­Ø³Ø§Ø¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª Ù…Ø·Ø¨Ù‚Ø© ÙˆÙ‚Øª Ø§Ù„Ø¨ÙŠØ¹ (unit_price_after_discount Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ invoice_out_items.total_after_discount Ø£Ùˆ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©). Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù‚ÙŠÙ… Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø³ÙŠØ§Ø³Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ±.

ğŸ§ª Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ù‚ØªØ±Ø­Ø© (Unit / Integration)

Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¬Ø§Ø­ Ø¥Ø±Ø¬Ø§Ø¹ Ø¬Ø²Ø¦ÙŠ Ù„Ø¨Ù†Ø¯ ÙˆØ§Ø­Ø¯: ØªØ­Ù‚Ù‚ DB state (batches, sia, invoice_out_items, returns, invoices_out).

Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù†Ø¯ Ù…Ø¹ Ø®ØµÙ… % ÙˆØ®ØµÙ… Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª.

Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø±Ø¬Ø§Ø¹ ÙØ§ØªÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø© (delivered => reverted).

Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø§Ù„Ø© Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹ Ù…Ø¹ return > paid.

Ø§Ø®ØªØ¨Ø§Ø± idempotency: Ù†ÙØ³ external_ref Ù…Ø±ØªÙŠÙ†.

Ø§Ø®ØªØ¨Ø§Ø± ØªÙ†Ø§ÙÙØ³: ØªÙ†ÙÙŠØ° Ø¥Ø±Ø¬Ø§Ø¹ÙŠÙ† Ù…ØªØ²Ø§Ù…Ù†ÙŠÙ† Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙÙ„ Ø§Ù„ØµÙÙˆÙ ÙˆÙ…Ù†Ø¹ ØªØ¬Ø§ÙˆØ² available_for_return).

Ø±ÙƒØ² ÙƒÙ…Ø§Ù† ØªØ³Ø¬Ù„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ ÙÙŠ



CREATE TABLE `returns` (
  `id` int(11) PRIMARY KEY AUTO_INCREMENT,
  `invoice_id` int(11) NOT NULL,
  `customer_id` int(11) NOT NULL,
  `return_date` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `total_amount` DECIMAL(12,2) NOT NULL DEFAULT 0.00,
  `return_type` ENUM('full','partial','exchange') DEFAULT 'partial',
  `status` ENUM('pending','approved','completed','rejected') DEFAULT 'pending',
  `reason` TEXT,
  `approved_by` int(11) NULL,
  `approved_at` DATETIME NULL,
  `created_by` int(11) NOT NULL,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `notes` TEXT
);

CREATE TABLE `return_items` (
  `id` int(11) PRIMARY KEY AUTO_INCREMENT,
  `return_id` int(11) NOT NULL,
  `invoice_item_id` int(11) NOT NULL,
  `product_id` int(11) NOT NULL,
  `quantity` DECIMAL(10,2) NOT NULL,
  `return_price` DECIMAL(10,2) NOT NULL, -- Ø§Ù„Ø³Ø¹Ø± ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
  `total_amount` DECIMAL(10,2) NOT NULL,
  `batch_allocations` JSON, -- Ù„ØªØªØ¨Ø¹ Ø£ÙŠ Ø¯ÙØ¹Ø§Øª ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹Ù‡Ø§
  `status` ENUM('pending','restocked','discarded') DEFAULT 'pending',
  `restocked_qty` DECIMAL(10,2) DEFAULT 0.00,
  `restocked_at` DATETIME NULL,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP
);